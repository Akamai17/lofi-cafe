<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>☕ Lo-Fi Café Spotify Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=DM+Sans:wght@300;400;500;600&family=Quicksand:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'cream': '#f5f1ec',
                        'latte-tan': '#d9cfc1',
                        'sage-green': '#c7d2c2',
                        'muted-plum': '#4a4e69',
                        'brown-gray': '#403d39',
                        'dusty-pink': '#f0a6ca'
                    },
                    fontFamily: {
                        'handwritten': ['Dancing Script', 'cursive'],
                        'sans': ['Open Sans', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        html, body {
            height: 100%;
        }
        body {
            background-color: #4a4e69;
            font-family: 'DM Sans', sans-serif;
            color: #403d39;
            overflow-x: hidden;
        }
        .bg-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-image: linear-gradient(to bottom right, #f5f1ec, #d9cfc1, #c7d2c2); transition: background-image 1s ease; z-index: -2; }
        body.theme-night .bg-container { background-image: linear-gradient(to bottom right, #4a4e69, #403d39, #2c2b28); }
        .blob { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.3; z-index: -1; animation: move 40s infinite alternate; }
        .blob-1 { width: 400px; height: 400px; top: -150px; left: -150px; background: #f0a6ca; }
        .blob-2 { width: 300px; height: 300px; top: 10vh; right: 5vw; background: #c7d2c2; animation-delay: 5s; animation-duration: 35s; }
        .blob-3 { width: 250px; height: 250px; bottom: -100px; left: 20vw; background: #d9cfc1; animation-delay: 10s; animation-duration: 50s; }
        @keyframes move { from { transform: translate(0, 0) scale(1); } to { transform: translate(200px, 100px) scale(1.4); } }
        body.theme-night { color: #f5f1ec; }
        body.theme-night .blur-bg { background-color: rgba(0, 0, 0, 0.25); border: 1px solid rgba(255, 255, 255, 0.1); }
        body.theme-night .blur-bg h2, body.theme-night .blur-bg h3#userName, body.theme-night .playlist-item p, body.theme-night #artistName { color: #f5f1ec; }
        body.theme-night .blur-bg .text-gray-600 { color: #d9cfc1; }
        body.theme-night .playlist-item:hover { background-color: rgba(245, 241, 236, 0.1); }
        body.theme-night .login-container p, body.theme-night .login-container h1 { color: #403d39; }
        button.active { color: #f0a6ca; text-shadow: 0 0 5px #f0a6ca; }
        .blur-bg { backdrop-filter: blur(16px) saturate(180%); -webkit-backdrop-filter: blur(16px) saturate(180%); background-color: rgba(255, 255, 255, 0.35); border: 1px solid rgba(255, 255, 255, 0.2); }
        .playlist-item:hover { transform: translateX(5px); }
        .record-container { position: relative; width: 224px; height: 224px; flex-shrink: 0; }
        .record { width: 100%; height: 100%; position: relative; background: #222; border-radius: 50%; background-image: repeating-radial-gradient(circle at center, rgba(255,255,255,0.03) 0px, rgba(255,255,255,0.03) 1px, transparent 1px, transparent 2px); box-shadow: 0 0 20px rgba(0,0,0,0.5); animation: spin 20s linear infinite; animation-play-state: paused; }
        .playing .record { animation-play-state: running; }
        #record-label { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 40%; height: 40%; background-color: #f0a6ca; background-size: cover; background-position: center; border-radius: 50%; box-shadow: 0 0 10px rgba(0,0,0,0.8) inset; }
        .spindle-hole { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 7%; height: 7%; background: #f5f1ec; border-radius: 50%; box-shadow: 0 0 2px 1px rgba(0,0,0,0.4) inset; border: 1px solid #ddd; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .loading-spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #f0a6ca; border-radius: 50%; animation: spin 1s linear infinite; }
        .login-container { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-radius: 20px; padding: 40px; text-align: center; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }
        input[type="range"]::-webkit-slider-runnable-track { background: #d9cfc1; height: 0.5rem; border-radius: 0.25rem; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; margin-top: -4px; background-color: #f0a6ca; height: 1.25rem; width: 1.25rem; border-radius: 50%; }
        body.theme-night input[type="range"]::-webkit-slider-runnable-track { background: #4a4e69; }
    </style>
</head>
<body class="min-h-screen">
    <!-- Backgrounds and Login -->
    <div class="bg-container"><div class="blob blob-1"></div><div class="blob blob-2"></div><div class="blob blob-3"></div></div>
    <div id="loginScreen" class="fixed inset-0 flex items-center justify-center z-50"> <div class="login-container max-w-md w-full mx-4"> <div class="mb-6"><i class="fas fa-music text-6xl text-dusty-pink mb-4"></i><h1 class="font-handwritten text-4xl text-muted-plum mb-2">Lo-Fi Spotify Player</h1><p class="text-gray-600">Connect to Spotify</p></div><div id="loginContent"><button id="loginBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full"><i class="fab fa-spotify mr-2"></i>Connect with Spotify</button></div><div id="loadingContent" class="hidden"><div class="loading-spinner mx-auto mb-4"></div><p class="text-gray-600">Connecting...</p></div></div></div>
    
    <!-- Main App -->
    <div id="mainApp" class="hidden max-w-7xl mx-auto w-full p-4 md:p-6"><div class="md:grid md:grid-cols-3 lg:grid-cols-4 md:gap-6">
        <div class="md:col-span-1 space-y-6">
            <div class="blur-bg rounded-2xl p-5"><div class="flex items-center"><img id="userAvatar" class="w-16 h-16 rounded-xl object-cover" src=""><div class="ml-4"><h3 id="userName" class="font-semibold">Loading...</h3><p id="userPlan" class="text-sm text-gray-600">Free</p></div></div><button id="logoutBtn" class="mt-4 text-sm text-dusty-pink"><i class="fas fa-sign-out-alt mr-2"></i>Logout</button></div>
            <div class="blur-bg rounded-2xl p-5"><h2 class="font-handwritten text-2xl text-dusty-pink mb-4">Your Playlists</h2><div id="playlistContainer" class="space-y-2 max-h-96 overflow-y-auto"><div class="loading-spinner mx-auto"></div></div></div>
            <div class="blur-bg rounded-2xl p-5"><h2 class="font-handwritten text-2xl text-dusty-pink mb-3">Ambiance Mixer</h2><div class="mb-4"><label for="ambientSelect1" class="text-sm font-medium text-gray-800">Channel 1</label><select id="ambientSelect1" class="w-full mt-1 p-2 rounded-lg bg-cream border border-latte-tan text-sm focus:outline-none focus:ring-2 focus:ring-dusty-pink text-gray-800"></select><input type="range" id="ambientSlider1" min="0" max="1" step="0.01" value="0" class="w-full mt-2"></div><div><label for="ambientSelect2" class="text-sm font-medium text-gray-800">Channel 2</label><select id="ambientSelect2" class="w-full mt-1 p-2 rounded-lg bg-cream border border-latte-tan text-sm focus:outline-none focus:ring-2 focus:ring-dusty-pink text-gray-800"></select><input type="range" id="ambientSlider2" min="0" max="1" step="0.01" value="0" class="w-full mt-2"></div></div>
        </div>
        <div class="md:col-span-2 lg:col-span-3 mt-6 md:mt-0 space-y-6">
            <div class="blur-bg rounded-2xl p-6"><h1 class="font-quicksand text-3xl md:text-4xl text-center mb-6 tracking-wide">Now Playing</h1><div class="flex flex-col md:flex-row items-center gap-8"><div class="record-container"><div class="record"><div id="record-label"></div><div class="spindle-hole"></div></div></div><div class="text-center md:text-left flex-grow w-full"><h2 id="trackName" class="font-semibold text-2xl md:text-3xl mb-2">No track playing</h2><p id="artistName" class="text-lg text-gray-600 mb-4">Select a track to start</p><div class="mb-4"><div class="w-full bg-latte-tan/50 rounded-full h-2 mb-2"><div id="progressBar" class="h-2 rounded-full" style="width:0;background:#f0a6ca;"></div></div><div class="flex justify-between text-sm text-gray-600"><span id="currentTime">0:00</span><span id="totalTime">0:00</span></div></div><div class="flex justify-center md:justify-start items-center space-x-6"><button id="shuffleBtn" class="text-2xl" title="Shuffle"><i class="fas fa-random"></i></button><button id="prevBtn" class="text-2xl" title="Previous"><i class="fas fa-step-backward"></i></button><button id="playBtn" class="w-12 h-12 rounded-full bg-dusty-pink flex items-center justify-center text-white text-xl" title="Play/Pause"><i class="fas fa-play"></i></button><button id="nextBtn" class="text-2xl" title="Next"><i class="fas fa-step-forward"></i></button><button id="repeatBtn" class="text-2xl" title="Repeat"><i class="fas fa-redo"></i></button></div><div class="mt-6 flex items-center justify-between"><div class="flex items-center"><i class="fas fa-volume-down text-dusty-pink mr-3"></i><input type="range" id="volumeSlider" class="w-32" min="0" max="100" value="50"></div><button id="connectBtn" class="text-2xl" title="Connect to a device"><i class="fas fa-computer"></i></button></div></div></div></div>
            <div class="blur-bg rounded-2xl p-6"><h2 class="font-handwritten text-2xl text-dusty-pink mb-4">Search Music</h2><div class="flex gap-4 mb-4"><input type="text" id="searchInput" placeholder="Search..." class="flex-grow px-4 py-2 rounded-lg border-none bg-latte-tan/50 focus:outline-none focus:ring-2 focus:ring-dusty-pink"><button id="searchBtn" class="bg-dusty-pink text-white px-6 py-2 rounded-lg"><i class="fas fa-search"></i></button></div><div id="searchResults" class="space-y-2 max-h-64 overflow-y-auto"></div></div>
        </div>
    </div></div>
    
    <button id="miniPlayerBtn" class="hidden fixed bottom-6 left-6 bg-dusty-pink text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg hover:bg-muted-plum" title="Open Mini-player"><i class="fas fa-window-minimize"></i></button>
    <div id="devicesModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"><div class="bg-cream rounded-2xl shadow-xl p-6 w-full max-w-sm text-gray-800"><h2 class="font-handwritten text-2xl text-muted-plum mb-4">Devices</h2><div id="deviceList" class="space-y-3"></div><button id="closeDevicesModalBtn" class="mt-6 w-full bg-dusty-pink text-white py-2 rounded-lg">Close</button></div></div>
    <audio id="ambientAudio1" loop></audio><audio id="ambientAudio2" loop></audio>
    <script>
        const CLIENT_ID='1d19feb1d43040d7bb13ddea90fc6468';const REDIRECT_URI='https://akamai17.github.io/lofi-cafe/';const WEATHER_API_KEY='e4cf7e3f782e4d81b6b02628250907';const SCOPES='user-read-private user-read-email user-read-playback-state user-modify-playback-state user-read-currently-playing streaming playlist-read-private playlist-read-collaborative';
        function generateRandomString(t){let e="";const o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let s=0;s<t;s++)e+=o.charAt(Math.floor(Math.random()*o.length));return e}async function generateCodeChallenge(t){const e=new TextEncoder().encode(t),o=await window.crypto.subtle.digest("SHA-256",e);return btoa(String.fromCharCode(...new Uint8Array(o))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}
        class SpotifyPlayer{constructor(){this.accessToken=null,this.player=null,this.deviceId=null,this.currentTrack=null,this.isPlaying=false,this.isShuffling=false,this.repeatState="off",this.miniplayerWindow=null,this.broadcastChannel=new BroadcastChannel("lofi_cafe_channel"),this.init()}async init(){const e=new URLSearchParams(window.location.search),t=e.get("code");if(t){document.getElementById("loadingContent").classList.remove("hidden"),document.getElementById("loginScreen").classList.remove("hidden");const e=await this.getAccessToken(t);e?(this.accessToken=e,sessionStorage.setItem("spotify_token",this.accessToken),window.history.replaceState({},document.title,window.location.pathname),this.initializeApp()):(alert("Authentication failed. Please try again."),this.showLoginScreen())}else{const e=sessionStorage.getItem("spotify_token");e?(this.accessToken=e,this.initializeApp()):this.showLoginScreen()}}async getAccessToken(e){const t=sessionStorage.getItem("spotify_code_verifier");if(!t)return null;try{const o=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({client_id:CLIENT_ID,grant_type:"authorization_code",code:e,redirect_uri:REDIRECT_URI,code_verifier:t})});if(!o.ok)return null;const s=await o.json();return s.access_token}catch(e){return null}}async login(){const e=generateRandomString(128);sessionStorage.setItem("spotify_code_verifier",e);const t=await generateCodeChallenge(e),o=new URL("https://accounts.spotify.com/authorize");o.search=new URLSearchParams({client_id:CLIENT_ID,response_type:"code",redirect_uri:REDIRECT_URI,scope:SCOPES,code_challenge_method:"S256",code_challenge:t}),window.location.href=o}logout(){sessionStorage.clear(),this.accessToken=null,this.player&&this.player.disconnect(),this.miniplayerWindow&&!this.miniplayerWindow.closed&&this.miniplayerWindow.close(),window.location.href=window.location.origin+window.location.pathname}showLoginScreen(){document.getElementById("mainApp").classList.add("hidden"),document.getElementById("miniPlayerBtn").classList.add("hidden"),document.getElementById("loginScreen").classList.remove("hidden"),document.getElementById("loginContent").classList.remove("hidden"),document.getElementById("loadingContent").classList.add("hidden")}initializeApp(){document.getElementById("loginScreen").classList.add("hidden"),document.getElementById("mainApp").classList.remove("hidden"),document.getElementById("miniPlayerBtn").classList.remove("hidden"),this.setupEventListeners(),this.startProgressUpdater(),this.loadUserProfile(),this.loadPlaylists(),this.initializeWebPlayback(),this.loadDynamicWeather()}async makeSpotifyRequest(e,t={}){try{const o=await fetch(`https://api.spotify.com/v1${e}`,{...t,headers:{"Authorization":`Bearer ${this.accessToken}`,...t.headers}});if(!o.ok){if(401===o.status)return this.logout(),null;return null}const s=await o.text();return s?JSON.parse(s):{}}catch(e){return null}}async loadUserProfile(){const e=await this.makeSpotifyRequest("/me");e&&(document.getElementById("userName").textContent=e.display_name||"User",document.getElementById("userPlan").textContent=e.product||"Free",e.images?.[0]?.url&&(document.getElementById("userAvatar").src=e.images[0].url))}async loadPlaylists(){const e=await this.makeSpotifyRequest("/me/playlists?limit=50"),t=document.getElementById("playlistContainer");e?(t.innerHTML="",e.items.forEach(e=>{const o=document.createElement("div");o.className="playlist-item cursor-pointer p-2 rounded-lg transition-all flex items-center gap-4",o.innerHTML=`<img src="${e.images?.[0]?.url||""}" class="w-12 h-12 rounded object-cover flex-shrink-0"><div class="overflow-hidden"><p class="font-medium truncate">${e.name}</p><p class="text-sm text-gray-600">${e.tracks.total} songs</p></div>`,o.addEventListener("click",()=>this.playItem(e.uri)),t.appendChild(o)})):t.innerHTML=`<p class="text-red-500 text-sm">Could not load playlists.</p>`}async playItem(e){if(!this.deviceId)return;await this.makeSpotifyRequest(`/me/player/play?device_id=${this.deviceId}`,{method:"PUT",body:JSON.stringify({context_uri:e}),headers:{"Content-Type":"application/json"}})}async initializeWebPlayback(){await new Promise(e=>{if(window.Spotify)e();else{const t=document.createElement("script");t.src="https://sdk.scdn.co/spotify-player.js",t.async=!0,document.head.appendChild(t),window.onSpotifyWebPlaybackSDKReady=e}}),this.player=new Spotify.Player({name:"Lo-Fi Café Player",getOAuthToken:e=>e(this.accessToken),volume:.5}),this.player.addListener("ready",({device_id:e})=>{this.deviceId=e}),this.player.addListener("player_state_changed",e=>{e&&this.updatePlayerState(e)}),await this.player.connect()}updatePlayerState(e){if(!e)return void(this.isPlaying=!1,document.getElementById("trackName").textContent="No track playing",document.getElementById("artistName").textContent="Select a track to start",document.getElementById("record-label").style.backgroundImage="none",document.querySelector(".record-container").classList.remove("playing"),document.getElementById("playBtn").innerHTML='<i class="fas fa-play"></i>');this.isPlaying=!e.paused,this.isShuffling=e.shuffle,this.repeatState=["off","context","track"][e.repeat_mode];const t=e.track_window.current_track;this.currentTrack=t,document.getElementById("trackName").textContent=t.name,document.getElementById("artistName").textContent=t.artists.map(e=>e.name).join(", "),document.getElementById("record-label").style.backgroundImage=`url('${t.album.images[0]?.url||""}')`,document.getElementById("totalTime").textContent=this.formatTime(t.duration_ms),document.querySelector(".record-container").classList.toggle("playing",this.isPlaying),document.getElementById("playBtn").innerHTML=this.isPlaying?'<i class="fas fa-pause"></i>':'<i class="fas fa-play"></i>',document.getElementById("shuffleBtn").classList.toggle("active",this.isShuffling),document.getElementById("repeatBtn").classList.toggle("active","off"!==this.repeatState),document.getElementById("repeatBtn").innerHTML="track"===this.repeatState?'<i class="fas fa-retweet"></i>':'<i class="fas fa-redo"></i>',this.broadcastChannel.postMessage({type:"STATE_UPDATE",payload:{trackName:t.name,artistName:t.artists.map(e=>e.name).join(", "),albumArt:t.album.images[0]?.url,isPlaying:this.isPlaying,position:e.position,duration_ms:t.duration_ms}})}async previousTrack(){const e=await this.player.getCurrentState();e&&e.position>5e3?this.player.seek(0):this.player.previousTrack()}async toggleShuffle(){this.isShuffling=!this.isShuffling,await this.makeSpotifyRequest(`/me/player/shuffle?state=${this.isShuffling}`,{method:"PUT"})}async toggleRepeat(){const e="off"===this.repeatState?"track":"off";await this.makeSpotifyRequest(`/me/player/repeat?state=${e}`,{method:"PUT"})}async togglePlay(){this.player&&this.player.togglePlay()}async nextTrack(){this.player&&this.player.nextTrack()}formatTime(e){const t=Math.floor(e/6e4),o=Math.floor(e%6e4/1e3).toString().padStart(2,"0");return`${t}:${o}`}async search(e){const t=await this.makeSpotifyRequest(`/search?q=${encodeURIComponent(e)}&type=track&limit=10`);if(!t)return;const o=document.getElementById("searchResults");o.innerHTML="",t.tracks.items.forEach(e=>{const t=document.createElement("div");t.className="flex items-center p-3 rounded-lg hover:bg-latte-tan/50 cursor-pointer",t.innerHTML=`<img src="${e.album.images[2]?.url||""}" class="w-12 h-12 rounded-lg mr-3"><div class="flex-grow overflow-hidden"><p class="font-medium truncate">${e.name}</p><p class="text-sm text-gray-600 truncate">${e.artists.map(e=>e.name).join(", ")}</p></div><button class="play-search-result text-dusty-pink hover:text-warm-brown flex-shrink-0 ml-2"><i class="fas fa-play"></i></button>`,t.querySelector(".play-search-result").addEventListener("click",t=>{t.stopPropagation(),this.playItem(e.uri)}),o.appendChild(t)})}openMiniplayer(){if(this.miniplayerWindow&&!this.miniplayerWindow.closed)return void this.miniplayerWindow.focus();const e="width=400,height=110,resizable=yes,scrollbars=no,status=no,noopener,noreferrer";this.miniplayerWindow=window.open("about:blank","miniplayer",e);const t=`<html><head><title>Lo-Fi Miniplayer</title><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"><style>html,body{height:100%;margin:0;font-family:'DM Sans',-apple-system,BlinkMacSystemFont,sans-serif;background-color:#000;color:white;overflow:hidden}.player-container{position:relative;width:100%;height:100%;display:flex;overflow:hidden}.bg-art{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;transform:scale(1.2);filter:blur(15px) brightness(.5);z-index:0}.player-content{width:100%;height:100%;display:flex;align-items:center;gap:1rem;padding:.75rem;box-sizing:border-box;z-index:1;backdrop-filter:blur(10px) saturate(180%);background:rgba(0,0,0,0.2)}#miniArt{width:80px;height:80px;border-radius:8px;flex-shrink:0}#main-content{flex-grow:1;display:flex;flex-direction:column;justify-content:center;height:100%;min-width:0}#trackName{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}#artistName{font-size:.8rem;color:#ccc}#progress{width:100%;background:hsla(0,0%,100%,.2);border-radius:2px;height:4px;margin:.5rem 0}.bar{width:0;height:100%;background:white;border-radius:2px}.controls{display:flex;align-items:center;gap:1.5rem;justify-content:center}button{background:0;border:0;color:white;font-size:1rem;cursor:pointer;opacity:.8;transition:all .2s ease}button:hover{opacity:1;transform:scale(1.1)}</style></head><body><div class="player-container"><img id="bgArt" src=""><div class="player-content"><img id="miniArt" src=""><div id="main-content"><div id="trackName">...</div><p id="artistName"></p><div id="progress"><div class="bar"></div></div><div class="controls"><button id="miniPrev" title="Previous"><i class="fas fa-step-backward"></i></button><button id="miniPlay" title="Play/Pause" style="font-size:1.5rem;"><i class="fas fa-play"></i></button><button id="miniNext" title="Next"><i class="fas fa-step-forward"></i></button></div></div></div></div><script>const c=new BroadcastChannel("lofi_cafe_channel");function f(t){const o=Math.floor(t/6e4),s=Math.floor(t%6e4/1e3).toString().padStart(2,"0");return\`\${o}:\${s}\`}c.onmessage=t=>{if("STATE_UPDATE"===t.data.type||"PROGRESS_UPDATE"===t.data.type){const{trackName:o,artistName:s,albumArt:n,isPlaying:i,position:r,duration_ms:a}=t.data.payload;o&&(document.getElementById("trackName").textContent=o),s&&(document.getElementById("artistName").textContent=s),n&&(document.getElementById("miniArt").src=n||"",document.getElementById("bgArt").src=n||""),null!=i&&(document.getElementById("miniPlay").innerHTML=i?'<i class="fas fa-pause"></i>':'<i class="fas fa-play"></i>'),null!=r&&a&&(document.querySelector(".bar").style.width=\`\${r/a*100}%\`)}};document.getElementById("miniPlay").onclick=()=>c.postMessage({type:"ACTION",payload:"togglePlay"}),document.getElementById("miniNext").onclick=()=>c.postMessage({type:"ACTION",payload:"nextTrack"}),document.getElementById("miniPrev").onclick=()=>c.postMessage({type:"ACTION",payload:"previousTrack"}),c.postMessage({type:"REQUEST_INIT_STATE"});<\/script></body></html>`;this.miniplayerWindow.document.write(t),this.miniplayerWindow.document.close()}setupEventListeners(){document.getElementById("playBtn").addEventListener("click",()=>this.togglePlay()),document.getElementById("prevBtn").addEventListener("click",()=>this.previousTrack()),document.getElementById("nextBtn").addEventListener("click",()=>this.nextTrack()),document.getElementById("shuffleBtn").addEventListener("click",()=>this.toggleShuffle()),document.getElementById("repeatBtn").addEventListener("click",()=>this.toggleRepeat()),document.getElementById("volumeSlider").addEventListener("input",e=>this.player.setVolume(e.target.value/100));const e=()=>{const e=document.getElementById("searchInput").value;e&&this.search(e)};document.getElementById("searchBtn").addEventListener("click",e),document.getElementById("searchInput").addEventListener("keypress",t=>{("Enter"===t.key)&&e()}),document.getElementById("logoutBtn").addEventListener("click",()=>this.logout()),document.getElementById("miniPlayerBtn").addEventListener("click",()=>this.openMiniplayer()),document.getElementById("connectBtn").addEventListener("click",()=>this.showDeviceList()),document.getElementById("closeDevicesModalBtn").addEventListener("click",()=>document.getElementById("devicesModal").classList.add("hidden")),this.broadcastChannel.onmessage=e=>{if("ACTION"===e.data.type)this[e.data.payload]();if("REQUEST_INIT_STATE"===e.data.type&&this.currentTrack){this.updatePlayerState({track_window:{current_track:this.currentTrack},paused:!this.isPlaying,shuffle:this.isShuffling,repeat_mode:["off","context","track"].indexOf(this.repeatState),position:this.lastPosition||0,duration:this.currentTrack.duration_ms});}}}startProgressUpdater(){setInterval(async()=>{if(this.isPlaying&&this.player){const e=await this.player.getCurrentState();if(e){this.lastPosition=e.position,document.getElementById("currentTime").textContent=this.formatTime(e.position),document.getElementById("progressBar").style.width=`${e.position/e.duration*100}%`,this.broadcastChannel.postMessage({type:"PROGRESS_UPDATE",payload:{position:e.position,duration_ms:e.duration}});}}},1e3)}async loadDynamicWeather(){navigator.geolocation.getCurrentPosition(async e=>{try{const t=await fetch(`https://api.weatherapi.com/v1/current.json?key=${WEATHER_API_KEY}&q=${e.coords.latitude},${e.coords.longitude}`);if(!t.ok)return;const o=await t.json();0===o.current.is_day&&document.body.classList.add("theme-night"),o.current.condition.text.toLowerCase().includes("rain")&&document.body.classList.add("weather-rain")}catch(e){}},()=>{((new Date).getHours()<6||(new Date).getHours()>19)&&document.body.classList.add("theme-night");});}}document.addEventListener("DOMContentLoaded",function(){const e=new SpotifyPlayer;document.getElementById("loginBtn").addEventListener("click",()=>e.login());const t={none:{name:"None",file:""},rain:{name:"Gentle Rain",file:"./assets/rain.mp3"},cafe:{name:"Coffee Shop",file:"./assets/cafe.mp3"},fire:{name:"Inazuma",file:"./assets/inazuma.mp3"}};const o=document.getElementById("ambientSelect1"),n=document.getElementById("ambientSlider1"),i=document.getElementById("ambientAudio1"),l=document.getElementById("ambientSelect2"),r=document.getElementById("ambientSlider2"),d=document.getElementById("ambientAudio2");function a(e){for(const o in t){const n=document.createElement("option");n.value=o,n.textContent=t[o].name,e.appendChild(n)}}a(o),a(l);function s(e,t,o){function n(){const i=t[e.value];o.volume=t.value;const l=i.file?new URL(i.file,window.location.href).href:"";o.src!==l&&(o.src=l,l&&o.load()),t.value>0&&i.file&&o.paused?o.play().catch(()=>{}) :0!=t.value&&i.file||o.pause()}e.addEventListener("change",n),t.addEventListener("input",n)}s(o,n,i),s(l,r,d);});
    </script>
</body>
</html>
