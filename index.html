<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>☕ Lo-Fi Café Spotify Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=DM+Sans:wght@300;400;500;600&family=Quicksand:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'cream': '#f5f1ec',
                        'latte-tan': '#d9cfc1',
                        'sage-green': '#c7d2c2',
                        'muted-plum': '#4a4e69',
                        'brown-gray': '#403d39',
                        'dusty-pink': '#f0a6ca'
                    },
                    fontFamily: {
                        'handwritten': ['Dancing Script', 'cursive'],
                        'sans': ['Open Sans', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        /* Base and Layout Fixes */
        body {
            background-color: #4a4e69; /* Fallback for a dark theme */
            font-family: 'DM Sans', sans-serif;
            color: #403d39;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }
        
        /* Animated Background Blobs */
        .bg-container {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-image: linear-gradient(to bottom right, #f5f1ec, #d9cfc1, #c7d2c2);
            transition: background-image 1s ease;
            z-index: -2;
        }
        body.theme-night .bg-container {
             background-image: linear-gradient(to bottom right, #4a4e69, #403d39, #2c2b28);
        }

        .blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.3;
            z-index: -1;
            animation: move 40s infinite alternate;
        }
        .blob-1 { width: 400px; height: 400px; top: -150px; left: -150px; background: #f0a6ca; }
        .blob-2 { width: 300px; height: 300px; top: 10vh; right: 5vw; background: #c7d2c2; animation-delay: 5s; animation-duration: 35s; }
        .blob-3 { width: 250px; height: 250px; bottom: -100px; left: 20vw; background: #d9cfc1; animation-delay: 10s; animation-duration: 50s;}

        @keyframes move {
            from { transform: translate(0, 0) scale(1); }
            to { transform: translate(200px, 100px) scale(1.4); }
        }

        /* Night Theme Adjustments */
        body.theme-night { color: #f5f1ec; }
        body.theme-night .blur-bg { background-color: rgba(0, 0, 0, 0.25); border: 1px solid rgba(255, 255, 255, 0.1); }
        body.theme-night .blur-bg h2, body.theme-night .blur-bg h3#userName, body.theme-night .playlist-item p { color: #f5f1ec; }
        body.theme-night .blur-bg .text-gray-600 { color: #d9cfc1; }
        body.theme-night .playlist-item:hover { background-color: rgba(245, 241, 236, 0.1); }
        body.theme-night .spotify-btn { color: #403d39; } /* Fix for login screen button */
        body.theme-night .text-muted-plum { color: #f5f1ec; }
        body.theme-night button.active { color: #f0a6ca; }
        
        /* General UI and Fixes */
        .blur-bg { backdrop-filter: blur(16px); background-color: rgba(255, 255, 255, 0.25); border: 1px solid rgba(255, 255, 255, 0.18); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15); }
        .playlist-item:hover { transform: translateX(5px); }
        button.active { color: #f0a6ca; text-shadow: 0 0 5px #f0a6ca; }

        /* Vinyl Animation */
        .vinyl-container {
            position: relative;
            width: 224px; height: 224px; /* Default for md size */
        }
        .vinyl-record {
            width: 100%; height: 100%;
            background: #222;
            border-radius: 50%;
            background-image: repeating-radial-gradient(circle at center, rgba(255,255,255,0.02) 0px, rgba(255,255,255,0.02) 2px, transparent 2px, transparent 4px);
            animation: spin 20s linear infinite;
            animation-play-state: paused;
        }
        .playing .vinyl-record { animation-play-state: running; }
        .vinyl-label {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 33%; height: 33%;
            background: #e6e6e6;
            border-radius: 50%;
            border: 1px solid #aaa;
            box-shadow: 0 0 5px rgba(0,0,0,0.5) inset;
        }
        #albumArt {
            position: absolute;
            top: 10%; left: 10%;
            width: 80%; height: 80%;
            border-radius: 4px; /* Vinyls often had square art in the center */
        }
        
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .loading-spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #f0a6ca; border-radius: 50%; animation: spin 1s linear infinite; }
        .login-container { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-radius: 20px; padding: 40px; text-align: center; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="min-h-screen">
    <!-- Animated BG container -->
    <div class="bg-container">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
    </div>
    
    <!-- Login Screen -->
    <div id="loginScreen" class="fixed inset-0 flex items-center justify-center z-50">
        <div class="login-container max-w-md w-full mx-4">
            <div class="mb-6"><i class="fas fa-music text-6xl text-dusty-pink mb-4"></i><h1 class="font-handwritten text-4xl text-muted-plum mb-2">Lo-Fi Spotify Player</h1><p class="text-gray-600">Connect to Spotify to start your musical journey</p></div>
            <div id="loginContent"><button id="loginBtn" class="spotify-btn"><i class="fab fa-spotify text-xl"></i>Connect with Spotify</button></div>
            <div id="loadingContent" class="hidden"><div class="loading-spinner mx-auto mb-4"></div><p class="text-gray-600">Connecting to Spotify...</p></div>
        </div>
    </div>
    
    <!-- Main App Container -->
    <div id="mainApp" class="hidden max-w-7xl mx-auto w-full p-4 md:p-6">
        <div class="md:grid md:grid-cols-3 lg:grid-cols-4 md:gap-6">
            <!-- Sidebar (now part of the grid) -->
            <div class="md:col-span-1 space-y-6">
                <div class="blur-bg rounded-2xl p-5"><div class="flex items-center"><img id="userAvatar" class="w-16 h-16 rounded-xl object-cover" src="" alt="User Avatar"><div class="ml-4"><h3 id="userName" class="font-semibold">Loading...</h3><p id="userPlan" class="text-sm text-gray-600">Premium</p></div></div><button id="logoutBtn" class="mt-4 text-sm text-dusty-pink"><i class="fas fa-sign-out-alt mr-2"></i>Logout</button></div>
                <div class="blur-bg rounded-2xl p-5"><h2 class="font-handwritten text-2xl text-dusty-pink mb-4">Your Playlists</h2><div id="playlistContainer" class="space-y-2 max-h-96 overflow-y-auto"><div class="loading-spinner mx-auto"></div></div></div>
                <div class="blur-bg rounded-2xl p-5">
                    <h2 class="font-handwritten text-2xl text-dusty-pink mb-3">Ambiance Mixer</h2>
                    <div class="mb-4"><label for="ambientSelect1" class="text-sm font-medium">Channel 1</label><select id="ambientSelect1" class="w-full mt-1 p-2 rounded-lg bg-cream border border-latte-tan text-sm focus:outline-none focus:ring-2 focus:ring-dusty-pink text-gray-800"></select><input type="range" id="ambientSlider1" min="0" max="1" step="0.01" value="0" class="w-full mt-2"></div>
                    <div><label for="ambientSelect2" class="text-sm font-medium">Channel 2</label><select id="ambientSelect2" class="w-full mt-1 p-2 rounded-lg bg-cream border border-latte-tan text-sm focus:outline-none focus:ring-2 focus:ring-dusty-pink text-gray-800"></select><input type="range" id="ambientSlider2" min="0" max="1" step="0.01" value="0" class="w-full mt-2"></div>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="md:col-span-2 lg:col-span-3 mt-6 md:mt-0 space-y-6">
                <div class="blur-bg rounded-2xl p-6">
                    <h1 class="font-quicksand text-3xl md:text-4xl text-center mb-6 tracking-wide">Now Playing</h1>
                    <div class="flex flex-col md:flex-row items-center gap-8">
                        <div class="vinyl-container flex-shrink-0">
                            <div class="vinyl-record"></div><div class="vinyl-label"></div><img id="albumArt" src="" alt="Album Art">
                        </div>
                        <div class="text-center md:text-left flex-grow w-full">
                            <h2 id="trackName" class="font-semibold text-2xl md:text-3xl mb-2">No track playing</h2>
                            <p id="artistName" class="text-lg text-gray-600 mb-4">Select a track to start</p>
                            <div class="mb-4"><div class="w-full bg-gray-200 rounded-full h-2 mb-2"><div id="progressBar" class="h-2 rounded-full" style="width: 0%; background: #f0a6ca;"></div></div><div class="flex justify-between text-sm text-gray-600"><span id="currentTime">0:00</span><span id="totalTime">0:00</span></div></div>
                            <div class="flex justify-center md:justify-start items-center space-x-6"><button id="shuffleBtn" class="text-2xl" title="Shuffle"><i class="fas fa-random"></i></button><button id="prevBtn" class="text-2xl" title="Previous"><i class="fas fa-step-backward"></i></button><button id="playBtn" class="w-12 h-12 rounded-full bg-dusty-pink flex items-center justify-center text-white text-xl" title="Play/Pause"><i class="fas fa-play"></i></button><button id="nextBtn" class="text-2xl" title="Next"><i class="fas fa-step-forward"></i></button><button id="repeatBtn" class="text-2xl" title="Repeat"><i class="fas fa-redo"></i></button></div>
                            <div class="mt-6 flex items-center justify-between"><div class="flex items-center"><i class="fas fa-volume-down text-dusty-pink mr-3"></i><input type="range" id="volumeSlider" class="w-32" min="0" max="100" value="50"></div><button id="connectBtn" class="text-2xl" title="Connect to a device"><i class="fas fa-computer"></i></button></div>
                        </div>
                    </div>
                </div>
                <div class="blur-bg rounded-2xl p-6">
                    <h2 class="font-handwritten text-2xl text-dusty-pink mb-4">Search Music</h2>
                    <div class="flex gap-4 mb-4"><input type="text" id="searchInput" placeholder="Search..." class="flex-grow px-4 py-2 rounded-lg border-none bg-latte-tan/50 focus:outline-none focus:ring-2 focus:ring-dusty-pink"><button id="searchBtn" class="bg-dusty-pink text-white px-6 py-2 rounded-lg"><i class="fas fa-search"></i></button></div>
                    <div id="searchResults" class="space-y-2 max-h-64 overflow-y-auto"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Floating Action Buttons -->
    <button id="miniPlayerBtn" class="fixed bottom-6 left-6 bg-dusty-pink text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg hover:bg-muted-plum transition-colors"><i class="fas fa-window-minimize"></i></button>
    <div id="devicesModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"><div class="bg-cream rounded-2xl shadow-xl p-6 w-full max-w-sm text-gray-800"><h2 class="font-handwritten text-2xl text-muted-plum mb-4">Connect to a device</h2><div id="deviceList" class="space-y-3"></div><button id="closeDevicesModalBtn" class="mt-6 w-full bg-dusty-pink text-white py-2 rounded-lg">Close</button></div></div>
    
    <audio id="ambientAudio1" loop></audio>
    <audio id="ambientAudio2" loop></audio>

    <script>
        // --- API CONFIG ---
        const CLIENT_ID = '1d19feb1d43040d7bb13ddea90fc6468';
        const REDIRECT_URI = 'https://akamai17.github.io/lofi-cafe/';
        const WEATHER_API_KEY = 'e4cf7e3f782e4d81b6b02628250907';
        const SCOPES = 'user-read-private user-read-email user-read-playback-state user-modify-playback-state user-read-currently-playing streaming playlist-read-private playlist-read-collaborative user-top-read';
        
        class SpotifyPlayer {
            constructor() {
                this.accessToken = null; this.player = null; this.deviceId = null; this.currentTrack = null;
                this.isPlaying = false; this.isShuffling = false; this.repeatState = 'off'; // 'off', 'context', 'track'
                this.miniplayerWindow = null; this.broadcastChannel = new BroadcastChannel('lofi_cafe_channel');
                this.init();
            }

            // --- AUTH LOGIC ---
            async init() { const params = new URLSearchParams(window.location.search); const code = params.get('code'); if (code) { document.getElementById('loginScreen').classList.remove('hidden'); document.getElementById('loadingContent').classList.remove('hidden'); await this.getAccessToken(code); window.history.replaceState({}, document.title, window.location.pathname); await this.initializeApp(); } else { const storedToken = sessionStorage.getItem('spotify_token'); if (storedToken) { this.accessToken = storedToken; await this.initializeApp(); } else { document.getElementById('mainApp').classList.add('hidden'); document.getElementById('loginScreen').classList.remove('hidden'); } } }
            async getAccessToken(code) { const codeVerifier = sessionStorage.getItem('spotify_code_verifier'); if (!codeVerifier) { this.logout(); return; } try { const response = await fetch('https://accounts.spotify.com/api/token', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: new URLSearchParams({ client_id: CLIENT_ID, grant_type: 'authorization_code', code: code, redirect_uri: REDIRECT_URI, code_verifier: codeVerifier }), }); if (!response.ok) throw new Error('Failed to fetch access token'); const data = await response.json(); this.accessToken = data.access_token; sessionStorage.setItem('spotify_token', this.accessToken); } catch (error) { this.logout(); } }
            async login() { const codeVerifier = Array.from(window.crypto.getRandomValues(new Uint8Array(32))).map(b => String.fromCharCode(b)).join('').substring(0, 128); const codeChallenge = await generateCodeChallenge(codeVerifier); sessionStorage.setItem('spotify_code_verifier', codeVerifier); const authUrl = new URL('https://accounts.spotify.com/authorize'); authUrl.search = new URLSearchParams({ client_id: CLIENT_ID, response_type: 'code', redirect_uri: REDIRECT_URI, scope: SCOPES, code_challenge_method: 'S256', code_challenge: codeChallenge }).toString(); window.location.href = authUrl.toString(); }
            logout() { sessionStorage.clear(); this.accessToken = null; if (this.player) this.player.disconnect(); if(this.miniplayerWindow) this.miniplayerWindow.close(); window.location.href = window.location.origin + window.location.pathname; }
            
            async initializeApp() {
                document.getElementById('loginScreen').classList.add('hidden'); document.getElementById('mainApp').classList.remove('hidden');
                this.setupEventListeners(); this.startProgressUpdater(); this.loadUserProfile(); this.loadPlaylists(); this.initializeWebPlayback(); this.loadDynamicWeather();
            }

            // --- CORE API AND PLAYER LOGIC ---
            async makeSpotifyRequest(endpoint, options = {}) { const response = await fetch(`https://api.spotify.com/v1${endpoint}`, { ...options, headers: { 'Authorization': `Bearer ${this.accessToken}`, 'Content-Type': 'application/json', ...options.headers } }); if (!response.ok) { if (response.status === 401) this.logout(); throw new Error(`API error: ${response.status}`); } const text = await response.text(); return text ? JSON.parse(text) : {}; }
            async loadUserProfile() { try { const profile = await this.makeSpotifyRequest('/me'); document.getElementById('userName').textContent = profile.display_name || 'User'; document.getElementById('userPlan').textContent = profile.product || 'Free'; if (profile.images?.[0]?.url) document.getElementById('userAvatar').src = profile.images[0].url; } catch (e) {} }
            async loadPlaylists() { try { const data = await this.makeSpotifyRequest('/me/playlists?limit=50'); const container = document.getElementById('playlistContainer'); container.innerHTML = ''; data.items.forEach(p => { const el = document.createElement('div'); el.className = 'playlist-item cursor-pointer p-2 rounded-lg transition-all flex items-center gap-4'; el.innerHTML = `<img src="${p.images?.[0]?.url || ''}" class="w-12 h-12 rounded object-cover flex-shrink-0"><div class="overflow-hidden"><p class="font-medium truncate">${p.name}</p><p class="text-sm text-gray-600">${p.tracks.total} songs</p></div>`; el.addEventListener('click', () => this.playItem(p.uri)); container.appendChild(el); }); } catch (e) { document.getElementById('playlistContainer').innerHTML = `<p class="text-red-500 text-sm">Could not load playlists.</p>`; } }
            async playItem(uri) { if (!this.deviceId) return; try { await this.makeSpotifyRequest(`/me/player/play?device_id=${this.deviceId}`, { method: 'PUT', body: JSON.stringify({ context_uri: uri }) }); } catch (e) {} }
            
            async initializeWebPlayback() {
                await new Promise(resolve => { if (window.Spotify) resolve(); else { const script = document.createElement('script'); script.src = 'https://sdk.scdn.co/spotify-player.js'; script.async = true; document.head.appendChild(script); window.onSpotifyWebPlaybackSDKReady = resolve; } });
                this.player = new Spotify.Player({ name: 'Lo-Fi Café Player', getOAuthToken: cb => { cb(this.accessToken); }, volume: 0.5 });
                this.player.addListener('ready', ({ device_id }) => { this.deviceId = device_id; });
                this.player.addListener('player_state_changed', state => { if (state) this.updatePlayerState(state); });
                await this.player.connect();
            }

            updatePlayerState(state) {
                if (!state) return;
                this.isPlaying = !state.paused;
                this.isShuffling = state.shuffle;
                this.repeatState = ['off', 'context', 'track'][state.repeat_mode];
                const track = state.track_window.current_track;
                this.currentTrack = track;
                
                document.getElementById('trackName').textContent = track.name;
                document.getElementById('artistName').textContent = track.artists.map(a => a.name).join(', ');
                document.getElementById('albumArt').src = track.album.images[0]?.url || '';
                document.getElementById('totalTime').textContent = this.formatTime(track.duration_ms);
                document.getElementById('currentTime').textContent = this.formatTime(state.position);
                document.getElementById('progressBar').style.width = `${(state.position / track.duration_ms) * 100}%`;
                
                const vinylContainer = document.querySelector('.vinyl-container');
                if(this.isPlaying) {
                    document.getElementById('playBtn').innerHTML = '<i class="fas fa-pause"></i>';
                    vinylContainer.classList.add('playing');
                } else {
                    document.getElementById('playBtn').innerHTML = '<i class="fas fa-play"></i>';
                    vinylContainer.classList.remove('playing');
                }
                
                document.getElementById('shuffleBtn').classList.toggle('active', this.isShuffling);
                document.getElementById('repeatBtn').classList.toggle('active', this.repeatState !== 'off');
                if(this.repeatState === 'track') document.getElementById('repeatBtn').innerHTML = '<i class="fas fa-retweet"></i>'; else document.getElementById('repeatBtn').innerHTML = '<i class="fas fa-redo"></i>';

                this.broadcastChannel.postMessage({ type: 'STATE_UPDATE', payload: {
                    trackName: track.name, artistName: track.artists.map(a => a.name).join(', '),
                    albumArt: track.album.images[0]?.url, isPlaying: this.isPlaying
                }});
            }

            // --- CONTROL LOGIC ---
            async previousTrack() {
                const state = await this.player.getCurrentState();
                if (state && state.position > 5000) { this.player.seek(0); } else { this.player.previousTrack(); }
            }
            async toggleShuffle() { try { const newState = !this.isShuffling; await this.makeSpotifyRequest(`/me/player/shuffle?state=${newState}`, { method: 'PUT' }); document.getElementById('shuffleBtn').classList.toggle('active', newState); this.isShuffling = newState; } catch (e) {} }
            async toggleRepeat() {
                try {
                    const nextState = this.repeatState === 'off' ? 'track' : 'off';
                    await this.makeSpotifyRequest(`/me/player/repeat?state=${nextState}`, { method: 'PUT' });
                    document.getElementById('repeatBtn').classList.toggle('active', nextState !== 'off');
                    this.repeatState = nextState;
                } catch(e) {}
            }

            async togglePlay() { if (this.player) this.player.togglePlay(); }
            async nextTrack() { if (this.player) this.player.nextTrack(); }
            
            // --- UI AND DYNAMIC FEATURES ---
            formatTime(ms) { const m = Math.floor(ms / 60000); const s = Math.floor((ms % 60000) / 1000).toString().padStart(2, '0'); return `${m}:${s}`; }
            async loadDynamicWeather() {
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    try {
                        const res = await fetch(`https://api.weatherapi.com/v1/current.json?key=${WEATHER_API_KEY}&q=${pos.coords.latitude},${pos.coords.longitude}`);
                        if (!res.ok) return;
                        const data = await res.json();
                        if (data.current.is_day === 0) document.body.classList.add('theme-night');
                        if (data.current.condition.text.toLowerCase().includes('rain')) document.body.classList.add('weather-rain');
                    } catch (e) {}
                }, () => { // Geolocation denied, fallback to time
                    if(new Date().getHours() < 6 || new Date().getHours() > 19) document.body.classList.add('theme-night');
                });
            }

            openMiniplayer() {
                const miniHTML = `
                    <style>
                        body { margin: 0; font-family: 'DM Sans', sans-serif; background-color: #f5f1ec; overflow: hidden; }
                        .player { width: 100vw; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
                        img { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; z-index: -1; filter: blur(10px) brightness(0.7); transform: scale(1.1); }
                        #trackName { font-weight: 600; font-size: 1rem; color: white; }
                        #artistName { font-size: 0.8rem; color: #eee; }
                        .controls { margin-top: 1rem; display: flex; align-items: center; gap: 1rem; }
                        button { background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; }
                    </style>
                    <div class="player">
                        <img id="miniArt" src="">
                        <div id="trackName">No track playing</div>
                        <p id="artistName">...</p>
                        <div class="controls">
                            <button id="miniPrev"><i class="fas fa-step-backward"></i></button>
                            <button id="miniPlay"><i class="fas fa-play"></i></button>
                            <button id="miniNext"><i class="fas fa-step-forward"></i></button>
                        </div>
                    </div>
                    <script>
                        const channel = new BroadcastChannel('lofi_cafe_channel');
                        const playBtn = document.getElementById('miniPlay');
                        channel.onmessage = (event) => {
                            if (event.data.type === 'STATE_UPDATE') {
                                const { trackName, artistName, albumArt, isPlaying } = event.data.payload;
                                document.getElementById('trackName').textContent = trackName;
                                document.getElementById('artistName').textContent = artistName;
                                document.getElementById('miniArt').src = albumArt || '';
                                playBtn.innerHTML = isPlaying ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>';
                            }
                        };
                        playBtn.onclick = () => channel.postMessage({ type: 'ACTION', payload: 'togglePlay' });
                        document.getElementById('miniNext').onclick = () => channel.postMessage({ type: 'ACTION', payload: 'nextTrack' });
                        document.getElementById('miniPrev').onclick = () => channel.postMessage({ type: 'ACTION', payload: 'previousTrack' });
                    <\/script>`;

                this.miniplayerWindow = window.open('', 'miniplayer', 'width=320,height=320,resizable=no');
                this.miniplayerWindow.document.write(miniHTML);
                this.miniplayerWindow.document.head.innerHTML += `<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">`;
            }

            // --- SETUP ---
            setupEventListeners() {
                document.getElementById('playBtn').addEventListener('click', () => this.togglePlay());
                document.getElementById('prevBtn').addEventListener('click', () => this.previousTrack());
                document.getElementById('nextBtn').addEventListener('click', () => this.nextTrack());
                document.getElementById('shuffleBtn').addEventListener('click', () => this.toggleShuffle());
                document.getElementById('repeatBtn').addEventListener('click', () => this.toggleRepeat());
                document.getElementById('volumeSlider').addEventListener('input', (e) => this.player.setVolume(e.target.value / 100));
                const searchAction = () => { const query = document.getElementById('searchInput').value; if (query) this.search(query); };
                document.getElementById('searchBtn').addEventListener('click', searchAction);
                document.getElementById('searchInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') searchAction(); });
                document.getElementById('logoutBtn').addEventListener('click', () => this.logout());
                document.getElementById('miniPlayerBtn').addEventListener('click', () => this.openMiniplayer());
                document.getElementById('connectBtn').addEventListener('click', () => this.showDeviceList());
                document.getElementById('closeDevicesModalBtn').addEventListener('click', () => { document.getElementById('devicesModal').classList.add('hidden'); });

                // Handle messages from the miniplayer
                this.broadcastChannel.onmessage = (event) => {
                    if (event.data.type === 'ACTION') {
                        this[event.data.payload](); // Calls the function by name, e.g., this.togglePlay()
                    }
                }
            }
            
            startProgressUpdater() { setInterval(async () => { if (this.isPlaying && this.player) { const state = await this.player.getCurrentState(); if(state) { document.getElementById('currentTime').textContent = this.formatTime(state.position); document.getElementById('progressBar').style.width = `${(state.position / state.duration) * 100}%`; } } }, 1000); }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const spotifyPlayer = new SpotifyPlayer();
            document.getElementById('loginBtn').addEventListener('click', () => spotifyPlayer.login());
            const ambientSounds = { none: { name: 'None', file: '' }, rain: { name: 'Gentle Rain', file: './assets/rain.mp3' }, cafe: { name: 'Coffee Shop', file: './assets/cafe.mp3' }, fire: { name: 'Inazuma', file: './assets/inazuma.mp3' }};
            const select1 = document.getElementById('ambientSelect1'); const slider1 = document.getElementById('ambientSlider1'); const audio1 = document.getElementById('ambientAudio1');
            const select2 = document.getElementById('ambientSelect2'); const slider2 = document.getElementById('ambientSlider2'); const audio2 = document.getElementById('ambientAudio2');
            function populateSelect(selectElement) { for (const key in ambientSounds) { const option = document.createElement('option'); option.value = key; option.textContent = ambientSounds[key].name; selectElement.appendChild(option); } }
            populateSelect(select1); populateSelect(select2);
            function setupChannel(select, slider, audio) {
                function updateAudio() {
                    const soundInfo = ambientSounds[select.value];
                    audio.volume = slider.value;
                    const soundUrl = soundInfo.file ? new URL(soundInfo.file, window.location.href).href : '';
                    if (audio.src !== soundUrl) { audio.src = soundUrl; if(soundUrl) audio.load(); }
                    if (slider.value > 0 && soundInfo.file && audio.paused) { audio.play().catch(()=>{}); } 
                    else if (slider.value == 0 || !soundInfo.file) { audio.pause(); }
                }
                select.addEventListener('change', updateAudio);
                slider.addEventListener('input', updateAudio);
            }
            setupChannel(select1, slider1, audio1);
            setupChannel(select2, slider2, audio2);
        });

        // Helper function for auth
        async function generateCodeChallenge(codeVerifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(codeVerifier);
            const digest = await window.crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode(...new Uint8Array(digest)))
                .replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_');
        }
    </script>
</body>
</html>
