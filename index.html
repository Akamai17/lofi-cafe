<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>☕ Lo-Fi Café Spotify Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=DM+Sans:wght@300;400;500;600&family=Quicksand:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'cream': '#f5f1ec',
                        'latte-tan': '#d9cfc1',
                        'sage-green': '#c7d2c2',
                        'muted-plum': '#4a4e69',
                        'brown-gray': '#403d39',
                        'dusty-pink': '#f0a6ca'
                    },
                    fontFamily: {
                        'handwritten': ['Dancing Script', 'cursive'],
                        'sans': ['Open Sans', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #f5f1ec;
            background-image: linear-gradient(to bottom right, #f5f1ec, #d9cfc1, #c7d2c2);
            font-family: 'DM Sans', sans-serif;
            overflow-x: hidden;
            color: #403d39;
        }
        
        .cafe-bg {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 200 200"><rect width="200" height="200" fill="%23F9F5EB"/><path d="M20,20 Q100,40 180,20 Q160,100 180,180 Q100,160 20,180 Q40,100 20,20 Z" fill="%23D2B48C" opacity="0.05"/></svg>');
            background-size: cover;
            position: relative;
            overflow: hidden;
        }
        
        .rain {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
        
        .drop {
            position: absolute;
            width: 1px;
            height: 20px;
            background: linear-gradient(to bottom, rgba(182, 216, 242, 0.3), rgba(182, 216, 242, 0.1));
            animation: fall linear infinite;
        }
        
        @keyframes fall {
            to { transform: translateY(100vh); }
        }
        
        .vinyl {
            animation: spin 20s linear infinite;
            animation-play-state: paused;
        }
        
        .playing .vinyl {
            animation-play-state: running;
        }
        
        @keyframes spin {
            100% { transform: rotate(360deg); }
        }
        
        .progress-bar {
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(90deg, #9DC183 0%, #D4A5A5 100%);
            transition: width 0.3s ease;
        }
        
        .playlist-item:hover {
            transform: translateX(5px);
            background-color: rgba(210, 180, 140, 0.2);
        }
        
        .popup-animation {
            animation: popup 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            transform-origin: bottom right;
        }

        @keyframes popup {
            0% {
                transform: scale(0.8) translateY(20px);
                opacity: 0;
            }
            100% {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }
        
        .lyrics-container {
            mask-image: linear-gradient(to bottom, black 80%, transparent 100%);
        }
        
        .blur-bg {
            backdrop-filter: blur(12px);
            background-color: rgba(255, 255, 255, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }
        
        .plant {
            position: absolute;
            bottom: 0;
            z-index: -1;
        }
        
        .plant-1 {
            left: 5%;
            height: 120px;
        }
        
        .plant-2 {
            right: 10%;
            height: 90px;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #f0a6ca;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .login-container {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .spotify-btn {
            background: linear-gradient(45deg, #1DB954, #1ed760);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .spotify-btn:hover {
            background: linear-gradient(45deg, #1ed760, #1DB954);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(29, 185, 84, 0.3);
        }
    </style>
</head>
<body class="cafe-bg min-h-screen flex flex-col">
    <!-- Rain animation -->
    <div class="rain" id="rain"></div>
    
    <!-- Plants -->
    <div class="plant plant-1">
        <svg viewBox="0 0 64 128" xmlns="http://www.w3.org/2000/svg">
            <path d="M32,128 C10,100 15,70 20,50 C25,30 30,10 32,0 C34,10 39,30 44,50 C49,70 54,100 32,128 Z" fill="#9DC183"/>
        </svg>
    </div>
    <div class="plant plant-2">
        <svg viewBox="0 0 48 96" xmlns="http://www.w3.org/2000/svg">
            <path d="M24,96 C8,80 12,60 15,45 C18,30 21,15 24,0 C27,15 30,30 33,45 C36,60 40,80 24,96 Z" fill="#9DC183"/>
        </svg>
    </div>
    
    <!-- Login Screen -->
    <div id="loginScreen" class="fixed inset-0 flex items-center justify-center z-50">
        <div class="login-container max-w-md w-full mx-4">
            <div class="mb-6">
                <i class="fas fa-music text-6xl text-dusty-pink mb-4"></i>
                <h1 class="font-handwritten text-4xl text-muted-plum mb-2">Lo-Fi Spotify Player</h1>
                <p class="text-gray-600">Connect to Spotify to start your musical journey</p>
            </div>
            
            <div id="loginContent">
                <button id="loginBtn" class="spotify-btn">
                    <i class="fab fa-spotify text-xl"></i>
                    Connect with Spotify
                </button>
                <p class="text-sm text-gray-500 mt-4">
                    We'll redirect you to Spotify to authorize access to your account
                </p>
            </div>
            
            <div id="loadingContent" class="hidden">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p class="text-gray-600">Connecting to Spotify...</p>
            </div>
        </div>
    </div>
    
    <!-- Main App Container -->
    <div id="mainApp" class="hidden flex-col md:flex-row flex-grow max-w-7xl mx-auto w-full p-4 md:p-6">
        <!-- Sidebar -->
        <div class="w-full md:w-1/4 lg:w-1/5 flex flex-col mb-6 md:mb-0 md:mr-6">
            <!-- User Profile -->
            <div class="blur-bg rounded-2xl p-5 mb-6">
                <div class="flex items-center">
                    <img id="userAvatar" class="w-16 h-16 rounded-xl object-cover" src="" alt="User Avatar">
                    <div class="ml-4">
                        <h3 id="userName" class="font-semibold text-warm-brown">Loading...</h3>
                        <p id="userPlan" class="text-sm text-gray-600">Premium Member</p>
                    </div>
                </div>
                <button id="logoutBtn" class="mt-4 text-sm text-dusty-pink hover:text-warm-brown">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </button>
            </div>
            
            <!-- Playlists -->
            <div class="blur-bg rounded-2xl p-5 flex-grow flex flex-col">
                <h2 class="font-handwritten text-2xl text-dusty-pink mb-4">Your Playlists</h2>
                <!-- FIX #1: Added classes for max-height and scrolling -->
                <div id="playlistContainer" class="space-y-2 max-h-96 overflow-y-auto">
                    <div class="loading-spinner mx-auto"></div>
                </div>
            </div>
            
            <!-- Mood Board -->
            <div class="blur-bg rounded-2xl p-5 mt-6">
                <h2 class="font-handwritten text-2xl text-dusty-pink mb-3">Current Mood</h2>
                <div class="flex items-center">
                    <i class="fas fa-cloud-sun text-3xl text-sage mr-3"></i>
                    <div>
                        <p class="font-medium">Partly Cloudy</p>
                        <p class="text-sm">Perfect for relaxing</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="flex-grow flex flex-col">
            <!-- Now Playing Section -->
            <div class="blur-bg rounded-2xl p-6 mb-6">
                <h1 class="font-quicksand text-3xl md:text-4xl text-center text-muted-plum mb-6 tracking-wide">Now Playing</h1>
                
                <div class="flex flex-col md:flex-row items-center">
                    <!-- Album Art -->
                    <div class="relative mb-6 md:mb-0 md:mr-8">
                        <div class="vinyl relative w-48 h-48 md:w-56 md:h-56 mx-auto">
                            <div class="absolute inset-0 rounded-full bg-gradient-to-br from-warm-brown to-dusty-pink flex items-center justify-center">
                                <div class="absolute w-16 h-16 bg-black rounded-full"></div>
                                <div class="absolute w-6 h-6 bg-cream rounded-full"></div>
                            </div>
                        </div>
                        <img id="albumArt" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-40 h-40 md:w-48 md:h-48 rounded-xl object-cover" src="" alt="Album Art">
                    </div>
                    
                    <!-- Track Info -->
                    <div class="text-center md:text-left flex-grow">
                        <h2 id="trackName" class="font-semibold text-2xl md:text-3xl mb-2">No track playing</h2>
                        <p id="artistName" class="text-lg text-gray-700 mb-4">Select a track to start</p>
                        
                        <!-- Progress Bar -->
                        <div class="mb-4">
                            <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                                <div id="progressBar" class="progress-bar h-2 rounded-full" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between text-sm text-gray-600">
                                <span id="currentTime">0:00</span>
                                <span id="totalTime">0:00</span>
                            </div>
                        </div>
                        
                        <!-- Controls -->
                        <div class="flex justify-center md:justify-start items-center space-x-6">
                            <button id="shuffleBtn" class="text-2xl text-dusty-pink hover:text-warm-brown transition-colors">
                                <i class="fas fa-random"></i>
                            </button>
                            <button id="prevBtn" class="text-2xl text-dusty-pink hover:text-warm-brown transition-colors">
                                <i class="fas fa-step-backward"></i>
                            </button>
                            <button id="playBtn" class="w-12 h-12 rounded-full bg-dusty-pink flex items-center justify-center text-white hover:bg-warm-brown transition-colors">
                                <i class="fas fa-play"></i>
                            </button>
                            <button id="nextBtn" class="text-2xl text-dusty-pink hover:text-warm-brown transition-colors">
                                <i class="fas fa-step-forward"></i>
                            </button>
                            <button id="repeatBtn" class="text-2xl text-dusty-pink hover:text-warm-brown transition-colors">
                                <i class="fas fa-redo"></i>
                            </button>
                        </div>
                        
                        <!-- Volume Control -->
                        <div class="mt-6 flex items-center">
                            <i class="fas fa-volume-down text-dusty-pink mr-3"></i>
                            <input type="range" id="volumeSlider" class="w-32" min="0" max="100" value="50">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Search Section -->
            <div class="blur-bg rounded-2xl p-6 mb-6">
                <h2 class="font-handwritten text-2xl text-dusty-pink mb-4">Search Music</h2>
                <div class="flex gap-4 mb-4">
                    <input type="text" id="searchInput" placeholder="Search for tracks, artists, or albums..." 
                           class="flex-grow px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-dusty-pink">
                    <button id="searchBtn" class="bg-dusty-pink text-white px-6 py-2 rounded-lg hover:bg-warm-brown transition-colors">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div id="searchResults" class="space-y-2 max-h-64 overflow-y-auto"></div>
            </div>
            
            <!-- Stats Section -->
            <div class="blur-bg rounded-2xl p-6">
                <h2 class="font-handwritten text-2xl text-dusty-pink mb-4">Your Listening Stats</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-sage-green rounded-xl p-4 text-white">
                        <h3 class="font-semibold mb-2">Top Genre</h3>
                        <p id="topGenre" class="text-lg">Loading...</p>
                    </div>
                    <div class="bg-muted-plum rounded-xl p-4 text-white">
                        <h3 class="font-semibold mb-2">Top Artist</h3>
                        <p id="topArtist" class="text-lg">Loading...</p>
                    </div>
                    <div class="bg-dusty-pink rounded-xl p-4 text-white">
                        <h3 class="font-semibold mb-2">Followers</h3>
                        <p id="followers" class="text-lg">Loading...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Pop-out Button -->
    <button id="popoutBtn" class="hidden fixed bottom-6 left-6 bg-dusty-pink text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg hover:bg-warm-brown transition-colors">
        <i class="fas fa-external-link-alt"></i>
    </button>
    
    <script>
        // =================================================================================
        // SPOTIFY API CONFIGURATION
        // =================================================================================
        const CLIENT_ID = '1d19feb1d43040d7bb13ddea90fc6468'; // Your Client ID
        const REDIRECT_URI = 'https://akamai17.github.io/lofi-cafe/';
        // =================================================================================
        
        const SCOPES = [
            'user-read-private',
            'user-read-email',
            'user-read-playback-state',
            'user-modify-playback-state',
            'user-read-currently-playing',
            'streaming',
            'playlist-read-private',
            'playlist-read-collaborative',
            'user-top-read',
            'user-read-recently-played'
        ].join(' ');

        async function generateCodeChallenge(codeVerifier) {
            const data = new TextEncoder().encode(codeVerifier);
            const digest = await window.crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode.apply(null, [...new Uint8Array(digest)]))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, '');
        }
        
        class SpotifyPlayer {
            constructor() {
                this.accessToken = null;
                this.player = null;
                this.deviceId = null;
                this.currentTrack = null;
                this.isPlaying = false;
                this.init();
            }

            async init() {
                const params = new URLSearchParams(window.location.search);
                const code = params.get('code');
                if (code) {
                    document.getElementById('loginContent').classList.add('hidden');
                    document.getElementById('loadingContent').classList.remove('hidden');
                    document.getElementById('loginScreen').classList.remove('hidden');
                    await this.getAccessToken(code);
                    window.history.replaceState({}, document.title, window.location.pathname);
                    await this.initializeApp();
                } else {
                    const storedToken = sessionStorage.getItem('spotify_token');
                    if (storedToken) {
                        this.accessToken = storedToken;
                        await this.initializeApp();
                    } else {
                        this.showLoginScreen();
                    }
                }
            }
            
            async getAccessToken(code) {
                const codeVerifier = sessionStorage.getItem('spotify_code_verifier');
                if (!codeVerifier) {
                    console.error('Code verifier not found!');
                    this.logout();
                    return;
                }
                try {
                    const response = await fetch('https://accounts.spotify.com/api/token', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: new URLSearchParams({
                            client_id: CLIENT_ID,
                            grant_type: 'authorization_code',
                            code: code,
                            redirect_uri: REDIRECT_URI,
                            code_verifier: codeVerifier,
                        }),
                    });
                    if (!response.ok) throw new Error('Failed to fetch access token');
                    const data = await response.json();
                    this.accessToken = data.access_token;
                    sessionStorage.setItem('spotify_token', this.accessToken);
                } catch (error) {
                    console.error('Error getting access token:', error);
                    this.logout();
                }
            }

            async login() {
                const codeVerifier = btoa(window.crypto.getRandomValues(new Uint8Array(32)).toString()).substring(0, 128);
                sessionStorage.setItem('spotify_code_verifier', codeVerifier);
                const codeChallenge = await generateCodeChallenge(codeVerifier);
                const authUrl = new URL('https://accounts.spotify.com/authorize');
                authUrl.search = new URLSearchParams({
                    client_id: CLIENT_ID,
                    response_type: 'code',
                    redirect_uri: REDIRECT_URI,
                    scope: SCOPES,
                    code_challenge_method: 'S256',
                    code_challenge: codeChallenge,
                }).toString();
                window.location.href = authUrl.toString();
            }

            logout() {
                sessionStorage.removeItem('spotify_token');
                sessionStorage.removeItem('spotify_code_verifier');
                this.accessToken = null;
                if (this.player) this.player.disconnect();
                window.location.href = window.location.origin + window.location.pathname;
            }
            
            showLoginScreen() {
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById('popoutBtn').classList.add('hidden');
            }
            
            async initializeApp() {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('flex');
                document.getElementById('popoutBtn').classList.remove('hidden');
                try {
                    await this.loadUserProfile();
                    await this.loadPlaylists();
                    await this.loadTopTracks();
                    await this.initializeWebPlayback();
                    this.setupEventListeners();
                    this.startProgressUpdater();
                } catch (error) {
                    console.error('Error initializing app:', error);
                    if (error.message.includes('401')) {
                         alert('Your session has expired. Please log in again.');
                         this.logout();
                    } else {
                        alert('Failed to initialize Spotify connection. Please try logging in again.');
                        this.logout();
                    }
                }
            }
            
            async makeSpotifyRequest(endpoint, options = {}) {
                const response = await fetch(`https://api.spotify.com/v1${endpoint}`, {
                    ...options,
                    headers: {
                        'Authorization': `Bearer ${this.accessToken}`,
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });
                if (!response.ok) throw new Error(`Spotify API error: ${response.status}`);
                const text = await response.text();
                return text ? JSON.parse(text) : {};
            }
            
            async loadUserProfile() {
                try {
                    const profile = await this.makeSpotifyRequest('/me');
                    document.getElementById('userName').textContent = profile.display_name || 'Spotify User';
                    document.getElementById('userPlan').textContent = profile.product || 'Free';
                    document.getElementById('followers').textContent = profile.followers?.total || '0';
                    if (profile.images && profile.images.length > 0) {
                        document.getElementById('userAvatar').src = profile.images[0].url;
                    }
                } catch (error) { console.error('Error loading user profile:', error); }
            }
            
            async loadPlaylists() {
                try {
                    const playlists = await this.makeSpotifyRequest('/me/playlists?limit=50');
                    const container = document.getElementById('playlistContainer');
                    container.innerHTML = '';
                    playlists.items.forEach(playlist => {
                        const playlistEl = document.createElement('div');
                        playlistEl.className = 'playlist-item cursor-pointer p-3 rounded-xl transition-all duration-300';
                        playlistEl.innerHTML = `<p class="font-medium truncate">${playlist.name}</p><p class="text-sm text-gray-600">${playlist.tracks.total} songs</p>`;
                        playlistEl.addEventListener('click', () => this.playItem(playlist.uri));
                        container.appendChild(playlistEl);
                    });
                } catch (error) { console.error('Error loading playlists:', error); }
            }
            
            async playItem(uri) {
                if (!this.deviceId) {
                    alert('Spotify player is not ready yet. Please wait a moment and try again.');
                    return;
                }
                try {
                    const body = uri.includes(':playlist:') || uri.includes(':album:') ? { context_uri: uri } : { uris: [uri] };
                    await this.makeSpotifyRequest(`/me/player/play?device_id=${this.deviceId}`, {
                        method: 'PUT',
                        body: JSON.stringify(body)
                    });
                } catch (error) { console.error('Error playing item:', error); }
            }
            
            async loadTopTracks() {
                try {
                    const topArtists = await this.makeSpotifyRequest('/me/top/artists?limit=1&time_range=short_term');
                    if (topArtists.items.length > 0) {
                        const artist = topArtists.items[0];
                        document.getElementById('topArtist').textContent = artist.name;
                        if (artist.genres.length > 0) {
                            const genre = artist.genres[0].replace(/\b\w/g, l => l.toUpperCase());
                            document.getElementById('topGenre').textContent = genre;
                        } else {
                           document.getElementById('topGenre').textContent = 'Eclectic';
                        }
                    }
                } catch (error) { console.error('Error loading top tracks:', error); }
            }
            
            async initializeWebPlayback() {
                await new Promise(resolve => {
                    if (window.Spotify) resolve();
                    else {
                        const script = document.createElement('script');
                        script.src = 'https://sdk.scdn.co/spotify-player.js';
                        script.async = true;
                        document.head.appendChild(script);
                        window.onSpotifyWebPlaybackSDKReady = resolve;
                    }
                });
                this.player = new Spotify.Player({
                    name: 'Lo-Fi Café Player',
                    getOAuthToken: cb => { cb(this.accessToken); },
                    volume: 0.5
                });
                this.player.addListener('ready', ({ device_id }) => { this.deviceId = device_id; });
                this.player.addListener('not_ready', ({ device_id }) => { console.log('Device ID has gone offline', device_id); });
                this.player.addListener('player_state_changed', (state) => { if (state) this.updatePlayerState(state); });
                this.player.connect();
            }
            
            updatePlayerState(state) {
                if (!state) {
                    this.isPlaying = false;
                    document.getElementById('trackName').textContent = 'No track playing';
                    document.getElementById('artistName').textContent = 'Select a track to start';
                    document.getElementById('albumArt').src = '';
                    document.getElementById('playBtn').innerHTML = '<i class="fas fa-play"></i>';
                    document.querySelector('.vinyl').classList.remove('playing');
                    return;
                }
                const track = state.track_window.current_track;
                this.currentTrack = track;
                this.isPlaying = !state.paused;
                document.getElementById('trackName').textContent = track.name;
                document.getElementById('artistName').textContent = track.artists.map(a => a.name).join(', ');
                document.getElementById('albumArt').src = track.album.images[0]?.url || '';
                document.getElementById('totalTime').textContent = this.formatTime(track.duration_ms);
                document.getElementById('currentTime').textContent = this.formatTime(state.position);
                document.getElementById('progressBar').style.width = `${(state.position / track.duration_ms) * 100}%`;
                document.getElementById('playBtn').innerHTML = this.isPlaying ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>';
                document.querySelector('.vinyl').classList.toggle('playing', this.isPlaying);
            }
            
            formatTime(ms) {
                const minutes = Math.floor(ms / 60000);
                const seconds = Math.floor((ms % 60000) / 1000);
                return `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
            
            async search(query) {
                try {
                    const results = await this.makeSpotifyRequest(`/search?q=${encodeURIComponent(query)}&type=track&limit=10`);
                    const container = document.getElementById('searchResults');
                    container.innerHTML = '';
                    results.tracks.items.forEach(track => {
                        const trackEl = document.createElement('div');
                        trackEl.className = 'flex items-center p-3 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors';
                        trackEl.innerHTML = `
                            <img src="${track.album.images[2]?.url || ''}" alt="${track.name}" class="w-12 h-12 rounded-lg mr-3">
                            <div class="flex-grow overflow-hidden">
                                <p class="font-medium truncate">${track.name}</p>
                                <p class="text-sm text-gray-600 truncate">${track.artists.map(a => a.name).join(', ')}</p>
                            </div>
                            <button class="text-dusty-pink hover:text-warm-brown play-search-result flex-shrink-0 ml-2" data-uri="${track.uri}">
                                <i class="fas fa-play"></i>
                            </button>
                        `;
                        // FIX #2: Added the event listener to make the button work
                        trackEl.querySelector('.play-search-result').addEventListener('click', (e) => {
                            e.stopPropagation(); // Prevents the whole div from triggering a click
                            this.playItem(track.uri);
                        });
                        container.appendChild(trackEl);
                    });
                } catch (error) { console.error('Error searching:', error); }
            }
            
            async togglePlay() { if (this.player) await this.player.togglePlay(); }
            async nextTrack() { if (this.player) await this.player.nextTrack(); }
            async previousTrack() { if (this.player) await this.player.previousTrack(); }
            async setVolume(volume) { if (this.player) await this.player.setVolume(volume / 100); }
            
            async getCurrentPlayback() {
                if (this.isPlaying && this.player) {
                    const state = await this.player.getCurrentState();
                    if(state) {
                        document.getElementById('currentTime').textContent = this.formatTime(state.position);
                        document.getElementById('progressBar').style.width = `${(state.position / state.duration) * 100}%`;
                    }
                }
            }
            
            setupEventListeners() {
                document.getElementById('playBtn').addEventListener('click', () => this.togglePlay());
                document.getElementById('prevBtn').addEventListener('click', () => this.previousTrack());
                document.getElementById('nextBtn').addEventListener('click', () => this.nextTrack());
                document.getElementById('volumeSlider').addEventListener('input', (e) => this.setVolume(e.target.value));
                const searchAction = () => {
                    const query = document.getElementById('searchInput').value;
                    if (query) this.search(query);
                };
                document.getElementById('searchBtn').addEventListener('click', searchAction);
                document.getElementById('searchInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') searchAction();
                });
                document.getElementById('logoutBtn').addEventListener('click', () => this.logout());
                document.getElementById('popoutBtn').addEventListener('click', () => this.openMiniplayer());
            }
            
            startProgressUpdater() {
                setInterval(() => this.getCurrentPlayback(), 1000);
            }

            openMiniplayer() {
                alert("Miniplayer feature is under construction!");
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            createRain();
            const spotifyPlayer = new SpotifyPlayer();
            document.getElementById('loginBtn').addEventListener('click', () => {
                if (CLIENT_ID === 'YOUR_SPOTIFY_CLIENT_ID' || !CLIENT_ID) {
                    alert('Please set your Spotify Client ID in the script first!');
                    return;
                }
                document.getElementById('loginContent').classList.add('hidden');
                document.getElementById('loadingContent').classList.remove('hidden');
                spotifyPlayer.login();
            });
        });

        function createRain() {
            const rainContainer = document.getElementById('rain');
            if (!rainContainer) return;
            for (let i = 0; i < 100; i++) {
                const drop = document.createElement('div');
                drop.className = 'drop';
                drop.style.left = `${Math.random() * 100}%`;
                drop.style.animationDuration = `${1 + Math.random() * 2}s`;
                drop.style.animationDelay = `${Math.random() * 5}s`;
                rainContainer.appendChild(drop);
            }
        }
    </script>
</body>
</html>
