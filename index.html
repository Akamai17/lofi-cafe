<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>☕ Lo-Fi Café Spotify Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=DM+Sans:wght@300;400;500;600&family=Quicksand:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'cream': '#f5f1ec',
                        'latte-tan': '#d9cfc1',
                        'sage-green': '#c7d2c2',
                        'muted-plum': '#4a4e69',
                        'brown-gray': '#403d39',
                        'dusty-pink': '#f0a6ca'
                    },
                    fontFamily: {
                        'handwritten': ['Dancing Script', 'cursive'],
                        'sans': ['Open Sans', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        html, body {
            height: 100%;
        }
        body {
            background-color: #4a4e69;
            font-family: 'DM Sans', sans-serif;
            color: #403d39;
            overflow-x: hidden;
        }
        .bg-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-image: linear-gradient(to bottom right, #f5f1ec, #d9cfc1, #c7d2c2); transition: background-image 1s ease; z-index: -2; }
        body.theme-night .bg-container { background-image: linear-gradient(to bottom right, #4a4e69, #403d39, #2c2b28); }
        .blob { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.3; z-index: -1; animation: move 40s infinite alternate; }
        .blob-1 { width: 400px; height: 400px; top: -150px; left: -150px; background: #f0a6ca; }
        .blob-2 { width: 300px; height: 300px; top: 10vh; right: 5vw; background: #c7d2c2; animation-delay: 5s; animation-duration: 35s; }
        .blob-3 { width: 250px; height: 250px; bottom: -100px; left: 20vw; background: #d9cfc1; animation-delay: 10s; animation-duration: 50s; }
        @keyframes move { from { transform: translate(0, 0) scale(1); } to { transform: translate(200px, 100px) scale(1.4); } }
        body.theme-night { color: #f5f1ec; }
        body.theme-night .blur-bg { background-color: rgba(0, 0, 0, 0.25); border: 1px solid rgba(255, 255, 255, 0.1); }
        body.theme-night .blur-bg h2, body.theme-night .blur-bg h3#userName, body.theme-night .playlist-item p, body.theme-night #artistName { color: #f5f1ec; }
        body.theme-night .blur-bg .text-gray-600 { color: #d9cfc1; }
        body.theme-night .playlist-item:hover { background-color: rgba(245, 241, 236, 0.1); }
        body.theme-night .login-container p, body.theme-night .login-container h1 { color: #403d39; }
        button.active { color: #f0a6ca; text-shadow: 0 0 5px #f0a6ca; }
        .blur-bg { backdrop-filter: blur(16px) saturate(180%); -webkit-backdrop-filter: blur(16px) saturate(180%); background-color: rgba(255, 255, 255, 0.35); border: 1px solid rgba(255, 255, 255, 0.2); }
        .playlist-item:hover { transform: translateX(5px); }
        .vinyl-container { position: relative; width: 224px; height: 224px; flex-shrink: 0; }
        .vinyl-record { width: 100%; height: 100%; background: #222; border-radius: 50%; background-image: repeating-radial-gradient(circle at center, rgba(255,255,255,0.02) 0px, rgba(255,255,255,0.02) 2px, transparent 2px, transparent 4px); animation: spin 20s linear infinite; animation-play-state: paused; }
        .playing .vinyl-record { animation-play-state: running; }
        .vinyl-label { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 33%; height: 33%; background: #e6e6e6; border-radius: 50%; border: 1px solid #aaa; box-shadow: 0 0 5px rgba(0,0,0,0.5) inset; }
        #albumArt { position: absolute; top: 12.5%; left: 12.5%; width: 75%; height: 75%; object-fit: cover; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .loading-spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #f0a6ca; border-radius: 50%; animation: spin 1s linear infinite; }
        .login-container { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-radius: 20px; padding: 40px; text-align: center; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }
        input[type="range"]::-webkit-slider-runnable-track { background: #d9cfc1; height: 0.5rem; border-radius: 0.25rem; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; margin-top: -4px; background-color: #f0a6ca; height: 1.25rem; width: 1.25rem; border-radius: 50%; }
        body.theme-night input[type="range"]::-webkit-slider-runnable-track { background: #4a4e69; }
    </style>
</head>
<body class="min-h-screen">
    <div class="bg-container"><div class="blob blob-1"></div><div class="blob blob-2"></div><div class="blob blob-3"></div></div>
    <div id="loginScreen" class="fixed inset-0 flex items-center justify-center z-50"> <div class="login-container max-w-md w-full mx-4"> <div class="mb-6"><i class="fas fa-music text-6xl text-dusty-pink mb-4"></i><h1 class="font-handwritten text-4xl text-muted-plum mb-2">Lo-Fi Spotify Player</h1><p class="text-gray-600">Connect to Spotify to start your musical journey</p></div><div id="loginContent"><button id="loginBtn" class="spotify-btn"><i class="fab fa-spotify text-xl"></i>Connect with Spotify</button></div><div id="loadingContent" class="hidden"><div class="loading-spinner mx-auto mb-4"></div><p class="text-gray-600">Connecting to Spotify...</p></div></div></div>
    
    <div id="mainApp" class="hidden max-w-7xl mx-auto w-full p-4 md:p-6">
        <div class="md:grid md:grid-cols-3 lg:grid-cols-4 md:gap-6">
            <div class="md:col-span-1 space-y-6">
                <div class="blur-bg rounded-2xl p-5"><div class="flex items-center"><img id="userAvatar" class="w-16 h-16 rounded-xl object-cover" src="" alt="User Avatar"><div class="ml-4"><h3 id="userName" class="font-semibold">Loading...</h3><p id="userPlan" class="text-sm text-gray-600">Free</p></div></div><button id="logoutBtn" class="mt-4 text-sm text-dusty-pink"><i class="fas fa-sign-out-alt mr-2"></i>Logout</button></div>
                <div class="blur-bg rounded-2xl p-5"><h2 class="font-handwritten text-2xl text-dusty-pink mb-4">Your Playlists</h2><div id="playlistContainer" class="space-y-2 max-h-96 overflow-y-auto"><div class="loading-spinner mx-auto"></div></div></div>
                <div class="blur-bg rounded-2xl p-5"><h2 class="font-handwritten text-2xl text-dusty-pink mb-3">Ambiance Mixer</h2><div class="mb-4"><label for="ambientSelect1" class="text-sm font-medium text-gray-800">Channel 1</label><select id="ambientSelect1" class="w-full mt-1 p-2 rounded-lg bg-cream border border-latte-tan text-sm focus:outline-none focus:ring-2 focus:ring-dusty-pink text-gray-800"></select><input type="range" id="ambientSlider1" min="0" max="1" step="0.01" value="0" class="w-full mt-2"></div><div><label for="ambientSelect2" class="text-sm font-medium text-gray-800">Channel 2</label><select id="ambientSelect2" class="w-full mt-1 p-2 rounded-lg bg-cream border border-latte-tan text-sm focus:outline-none focus:ring-2 focus:ring-dusty-pink text-gray-800"></select><input type="range" id="ambientSlider2" min="0" max="1" step="0.01" value="0" class="w-full mt-2"></div></div>
            </div>
            <div class="md:col-span-2 lg:col-span-3 mt-6 md:mt-0 space-y-6">
                <div class="blur-bg rounded-2xl p-6"><h1 class="font-quicksand text-3xl md:text-4xl text-center mb-6 tracking-wide">Now Playing</h1><div class="flex flex-col md:flex-row items-center gap-8"><div class="vinyl-container"><div class="vinyl-record"></div><div class="vinyl-label"></div><img id="albumArt" src="" alt="Album Art"></div><div class="text-center md:text-left flex-grow w-full"><h2 id="trackName" class="font-semibold text-2xl md:text-3xl mb-2">No track playing</h2><p id="artistName" class="text-lg text-gray-600 mb-4">Select a track to start</p><div class="mb-4"><div class="w-full bg-latte-tan/50 rounded-full h-2 mb-2"><div id="progressBar" class="h-2 rounded-full" style="width: 0%; background: #f0a6ca;"></div></div><div class="flex justify-between text-sm text-gray-600"><span id="currentTime">0:00</span><span id="totalTime">0:00</span></div></div><div class="flex justify-center md:justify-start items-center space-x-6"><button id="shuffleBtn" class="text-2xl transition-colors" title="Shuffle"><i class="fas fa-random"></i></button><button id="prevBtn" class="text-2xl transition-colors" title="Previous"><i class="fas fa-step-backward"></i></button><button id="playBtn" class="w-12 h-12 rounded-full bg-dusty-pink flex items-center justify-center text-white text-xl" title="Play/Pause"><i class="fas fa-play"></i></button><button id="nextBtn" class="text-2xl transition-colors" title="Next"><i class="fas fa-step-forward"></i></button><button id="repeatBtn" class="text-2xl transition-colors" title="Repeat"><i class="fas fa-redo"></i></button></div><div class="mt-6 flex items-center justify-between"><div class="flex items-center"><i class="fas fa-volume-down text-dusty-pink mr-3"></i><input type="range" id="volumeSlider" class="w-32" min="0" max="100" value="50"></div><button id="connectBtn" class="text-2xl transition-colors" title="Connect to a device"><i class="fas fa-computer"></i></button></div></div></div></div>
                <div class="blur-bg rounded-2xl p-6"><h2 class="font-handwritten text-2xl text-dusty-pink mb-4">Search Music</h2><div class="flex gap-4 mb-4"><input type="text" id="searchInput" placeholder="Search..." class="flex-grow px-4 py-2 rounded-lg border-none bg-latte-tan/50 focus:outline-none focus:ring-2 focus:ring-dusty-pink"><button id="searchBtn" class="bg-dusty-pink text-white px-6 py-2 rounded-lg"><i class="fas fa-search"></i></button></div><div id="searchResults" class="space-y-2 max-h-64 overflow-y-auto"></div></div>
            </div>
        </div>
    </div>
    
    <button id="miniPlayerBtn" class="hidden fixed bottom-6 left-6 bg-dusty-pink text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg hover:bg-muted-plum transition-colors" title="Open Mini-player"><i class="fas fa-window-minimize"></i></button>
    <div id="devicesModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"><div class="bg-cream rounded-2xl shadow-xl p-6 w-full max-w-sm text-gray-800"><h2 class="font-handwritten text-2xl text-muted-plum mb-4">Connect to a device</h2><div id="deviceList" class="space-y-3"></div><button id="closeDevicesModalBtn" class="mt-6 w-full bg-dusty-pink text-white py-2 rounded-lg">Close</button></div></div>
    
    <audio id="ambientAudio1" loop></audio>
    <audio id="ambientAudio2" loop></audio>

    <script>
        const CLIENT_ID = '1d19feb1d43040d7bb13ddea90fc6468';
        const REDIRECT_URI = 'https://akamai17.github.io/lofi-cafe/';
        const WEATHER_API_KEY = 'e4cf7e3f782e4d81b6b02628250907';
        const SCOPES = 'user-read-private user-read-email user-read-playback-state user-modify-playback-state user-read-currently-playing streaming playlist-read-private playlist-read-collaborative';
        
        function generateRandomString(length) { const p = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'; let t = ''; for (let i = 0; i < length; i++) { t += p.charAt(Math.floor(Math.random() * p.length)); } return t; }
        async function generateCodeChallenge(v) { const d = new TextEncoder().encode(v); const h = await window.crypto.subtle.digest('SHA-256', d); return btoa(String.fromCharCode.apply(null, new Uint8Array(h))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, ''); }

        class SpotifyPlayer {
            constructor() { this.accessToken = null; this.player = null; this.deviceId = null; this.currentTrack = null; this.isPlaying = false; this.isShuffling = false; this.repeatState = 'off'; this.miniplayerWindow = null; this.broadcastChannel = new BroadcastChannel('lofi_cafe_channel'); this.init(); }
            
            // --- AUTHENTICATION FLOW ---
            async init() {
                const params = new URLSearchParams(window.location.search);
                const code = params.get('code');
                if (code) { this.handleAuthRedirect(code); }
                else { const token = sessionStorage.getItem('spotify_token'); if (token) { this.accessToken = token; this.initializeApp(); } else { this.showLoginScreen(); } }
            }
            async handleAuthRedirect(code) { this.showLoadingScreen(); const token = await this.getAccessToken(code); window.history.replaceState({}, document.title, window.location.pathname); if (token) { this.accessToken = token; sessionStorage.setItem('spotify_token', this.accessToken); this.initializeApp(); } else { alert('Authentication failed. Please try again.'); this.showLoginScreen(); } }
            async getAccessToken(code) { const verifier = sessionStorage.getItem('spotify_code_verifier'); if (!verifier) return null; try { const res = await fetch('https://accounts.spotify.com/api/token', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: new URLSearchParams({ client_id: CLIENT_ID, grant_type: 'authorization_code', code, redirect_uri: REDIRECT_URI, code_verifier: verifier }) }); return res.ok ? (await res.json()).access_token : null; } catch { return null; } }
            async login() { this.showLoadingScreen(); const verifier = generateRandomString(128); sessionStorage.setItem('spotify_code_verifier', verifier); const challenge = await generateCodeChallenge(verifier); const url = new URL('https://accounts.spotify.com/authorize'); url.search = new URLSearchParams({ client_id: CLIENT_ID, response_type: 'code', redirect_uri: REDIRECT_URI, scope: SCOPES, code_challenge_method: 'S256', code_challenge: challenge }); window.location.href = url; }
            logout() { sessionStorage.clear(); if (this.player) this.player.disconnect(); if (this.miniplayerWindow && !this.miniplayerWindow.closed) this.miniplayerWindow.close(); window.location.replace(window.location.pathname); }
            showLoginScreen() { document.getElementById('mainApp').classList.add('hidden'); document.getElementById('miniPlayerBtn').classList.add('hidden'); document.getElementById('loginScreen').classList.remove('hidden'); document.getElementById('loginContent').classList.remove('hidden'); document.getElementById('loadingContent').classList.add('hidden'); }
            showLoadingScreen() { document.getElementById('loginContent').classList.add('hidden'); document.getElementById('loadingContent').classList.remove('hidden'); document.getElementById('loginScreen').classList.remove('hidden'); document.getElementById('mainApp').classList.add('hidden'); }
            
            // --- MAIN APP INITIALIZATION ---
            initializeApp() { document.getElementById('loginScreen').classList.add('hidden'); document.getElementById('mainApp').classList.remove('hidden'); document.getElementById('miniPlayerBtn').classList.remove('hidden'); this.setupEventListeners(); this.startProgressUpdater(); this.loadUserProfile(); this.loadPlaylists(); this.initializeWebPlayback(); this.loadDynamicWeather(); }
            async makeSpotifyRequest(endpoint, options = {}) { try { const res = await fetch(`https://api.spotify.com/v1${endpoint}`, { ...options, headers: { 'Authorization': `Bearer ${this.accessToken}`, ...options.headers } }); if (!res.ok) { if (res.status === 401) this.logout(); return null; } const text = await res.text(); return text ? JSON.parse(text) : {}; } catch { return null; } }
            
            // --- UI & DATA LOADING ---
            async loadUserProfile() { const p = await this.makeSpotifyRequest('/me'); if (p) { document.getElementById('userName').textContent = p.display_name || 'User'; document.getElementById('userPlan').textContent = p.product || 'Free'; if (p.images?.[0]?.url) document.getElementById('userAvatar').src = p.images[0].url; } }
            async loadPlaylists() { const d = await this.makeSpotifyRequest('/me/playlists?limit=50'); const c = document.getElementById('playlistContainer'); if(d) { c.innerHTML = ''; d.items.forEach(p => { const e = document.createElement('div'); e.className = 'playlist-item cursor-pointer p-2 rounded-lg transition-all flex items-center gap-4'; e.innerHTML = `<img src="${p.images?.[0]?.url||''}" class="w-12 h-12 rounded object-cover flex-shrink-0"><div class="overflow-hidden"><p class="font-medium truncate">${p.name}</p><p class="text-sm text-gray-600">${p.tracks.total} songs</p></div>`; e.addEventListener('click', () => this.playContext(p.uri)); c.appendChild(e); }); } else { c.innerHTML = `<p class="text-red-500 text-sm">Could not load playlists.</p>`; } }
            async search(q) { const r = await this.makeSpotifyRequest(`/search?q=${encodeURIComponent(q)}&type=track&limit=10`); if (r) { const c = document.getElementById('searchResults'); c.innerHTML = ''; r.tracks.items.forEach(t => { const e = document.createElement('div'); e.className = 'flex items-center p-3 rounded-lg hover:bg-latte-tan/50 cursor-pointer'; e.innerHTML = `<img src="${t.album.images[2]?.url||''}" class="w-12 h-12 rounded-lg mr-3"><div class="flex-grow overflow-hidden"><p class="font-medium truncate">${t.name}</p><p class="text-sm text-gray-600 truncate">${t.artists.map(a=>a.name).join(', ')}</p></div><button class="text-dusty-pink play-search-result flex-shrink-0 ml-2"><i class="fas fa-play"></i></button>`; e.querySelector('.play-search-result').addEventListener('click', e => { e.stopPropagation(); this.playTrack(t.uri); }); c.appendChild(e); }); } }
            
            // --- PLAYBACK CONTROL ---
            async initializeWebPlayback() { await new Promise(r => { if (window.Spotify) r(); else { const s = document.createElement('script'); s.src='https://sdk.scdn.co/spotify-player.js'; s.async=true; document.head.appendChild(s); window.onSpotifyWebPlaybackSDKReady=r; } }); this.player = new Spotify.Player({ name: 'Lo-Fi Café Player', getOAuthToken: cb => cb(this.accessToken), volume: 0.5 }); this.player.addListener('ready', ({device_id})=>this.deviceId = device_id); this.player.addListener('player_state_changed', s=> this.updatePlayerState(s)); await this.player.connect(); }
            updatePlayerState(state) { if (!state) return; const t=state.track_window.current_track; this.currentTrack=t; this.isPlaying=!state.paused; this.isShuffling=state.shuffle; this.repeatState=['off','context','track'][state.repeat_mode]; const vc=document.querySelector('.vinyl-container'); vc.classList.toggle('playing',this.isPlaying); document.getElementById('trackName').textContent=t.name; document.getElementById('artistName').textContent=t.artists.map(a=>a.name).join(', '); document.getElementById('albumArt').src=t.album.images[0]?.url||''; document.getElementById('playBtn').innerHTML=this.isPlaying?'<i class="fas fa-pause"></i>':'<i class="fas fa-play"></i>'; document.getElementById('shuffleBtn').classList.toggle('active',this.isShuffling); document.getElementById('repeatBtn').classList.toggle('active',this.repeatState!=='off'); document.getElementById('repeatBtn').innerHTML=this.repeatState==='track'?'<i class="fas fa-retweet"></i>':'<i class="fas fa-redo"></i>'; this.broadcastChannel.postMessage({ type:'STATE_UPDATE', payload:{trackName:t.name,artistName:t.artists.map(a=>a.name).join(', '),albumArt:t.album.images[0]?.url,isPlaying:this.isPlaying} }); }
            async playContext(uri) { if(!this.deviceId) return; await this.makeSpotifyRequest(`/me/player/play?device_id=${this.deviceId}`,{method:'PUT',body:JSON.stringify({context_uri:uri}),headers:{'Content-Type':'application/json'}}); }
            async playTrack(uri) { if(!this.deviceId) return; await this.makeSpotifyRequest(`/me/player/play?device_id=${this.deviceId}`,{method:'PUT',body:JSON.stringify({uris:[uri]}),headers:{'Content-Type':'application/json'}}); }
            async previousTrack() { const s=await this.player.getCurrentState(); if(s?.position>5000)this.player.seek(0);else this.player.previousTrack();}
            async toggleShuffle() { this.isShuffling=!this.isShuffling; await this.makeSpotifyRequest(`/me/player/shuffle?state=${this.isShuffling}`,{method:'PUT'});}
            async toggleRepeat() { const n=this.repeatState==='off'?'track':'off'; await this.makeSpotifyRequest(`/me/player/repeat?state=${n}`,{method:'PUT'});}
            async togglePlay() { if (this.player) this.player.togglePlay();}
            async nextTrack() { if (this.player) this.player.nextTrack(); }
            formatTime(ms) { const m=Math.floor(ms/60000); const s=Math.floor((ms%60000)/1000).toString().padStart(2,'0'); return`${m}:${s}`; }

            // --- MINI PLAYER ---
            openMiniplayer() {
                const f='width=320,height=320,resizable=no,scrollbars=no,status=no'; const w=window.open('about:blank','miniplayer',f);
                const h=`<html><head><title>Miniplayer</title><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css><style>body{margin:0;font-family:'DM Sans',sans-serif;background-color:#000;color:white;text-align:center;overflow:hidden}.player{width:100vw;height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:space-between;padding:1.5rem 1rem}.bg-art{width:100%;height:100%;object-fit:cover;position:absolute;top:0;left:0;z-index:-1;filter:blur(15px) brightness(0.5);transform:scale(1.2)}#trackInfo{flex-grow:1;display:flex;flex-direction:column;justify-content:center}#miniArt{width:150px;height:150px;border-radius:8px;box-shadow:0 4px 15px rgba(0,0,0,0.5)}#trackName{font-weight:600;margin-top:1rem}#artistName{font-size:0.8rem;color:#ccc;margin-top:0.25rem}.controls{display:flex;align-items:center;gap:1.5rem}button{background:0;border:0;color:white;font-size:1.2rem;cursor:pointer;opacity:0.8;transition:all .2s ease}button:hover{opacity:1;transform:scale(1.1)}</style></head><body><div class=player><img id=bgArt src=""><img id=miniArt src=""><div id=trackInfo><div id=trackName>No track</div><p id=artistName>...</p></div><div class=controls><button id=miniPrev><i class="fas fa-step-backward"></i></button><button id=miniPlay style="font-size:1.8rem;"><i class="fas fa-play"></i></button><button id=miniNext><i class="fas fa-step-forward"></i></button></div></div><script>const c=new BroadcastChannel('lofi_cafe_channel');c.onmessage=e=>{if(e.data.type==='STATE_UPDATE'){const{trackName,artistName,albumArt,isPlaying}=e.data.payload;document.getElementById('trackName').textContent=trackName;document.getElementById('artistName').textContent=artistName;document.getElementById('miniArt').src=albumArt||'';document.getElementById('bgArt').src=albumArt||'';document.getElementById('miniPlay').innerHTML=isPlaying?'<i class="fas fa-pause"></i>':'<i class="fas fa-play"></i>'}};document.getElementById('miniPlay').onclick=()=>c.postMessage({type:'ACTION',payload:'togglePlay'});document.getElementById('miniNext').onclick=()=>c.postMessage({type:'ACTION',payload:'nextTrack'});document.getElementById('miniPrev').onclick=()=>c.postMessage({type:'ACTION',payload:'previousTrack'});c.postMessage({type:'REQUEST_INIT'});<\/script></body></html>`;
                if(w){w.document.write(h);w.document.close();this.miniplayerWindow=w;if(this.currentTrack){this.broadcastChannel.postMessage({type:'STATE_UPDATE',payload:{trackName:this.currentTrack.name,artistName:this.currentTrack.artists.map(a=>a.name).join(', '),albumArt:this.currentTrack.album.images[0]?.url,isPlaying:this.isPlaying}});}}
            }

            // --- LISTENERS & TIMERS ---
            setupEventListeners() { document.getElementById('playBtn').addEventListener('click',()=>{this.togglePlay()}); document.getElementById('prevBtn').addEventListener('click',()=>{this.previousTrack()}); document.getElementById('nextBtn').addEventListener('click',()=>{this.nextTrack()}); document.getElementById('shuffleBtn').addEventListener('click',()=>{this.toggleShuffle()}); document.getElementById('repeatBtn').addEventListener('click',()=>{this.toggleRepeat()}); document.getElementById('volumeSlider').addEventListener('input',e=>{if(this.player)this.player.setVolume(e.target.value/100)}); const searchAction=()=>{const q=document.getElementById('searchInput').value;if(q)this.search(q)}; document.getElementById('searchBtn').addEventListener('click',searchAction); document.getElementById('searchInput').addEventListener('keypress',e=>{if(e.key==='Enter')searchAction()}); document.getElementById('logoutBtn').addEventListener('click',()=>{this.logout()}); document.getElementById('miniPlayerBtn').addEventListener('click',()=>{this.openMiniplayer()}); this.broadcastChannel.onmessage=e=>{if(e.data.type==='ACTION')this[e.data.payload](); if(e.data.type==='REQUEST_INIT' && this.currentTrack)this.updatePlayerState({track_window:{current_track:this.currentTrack},paused:!this.isPlaying,shuffle:this.isShuffling,repeat_mode:['off','context','track'].indexOf(this.repeatState)})}; }
            startProgressUpdater() { setInterval(async()=>{if(this.isPlaying&&this.player){const s=await this.player.getCurrentState();if(s){document.getElementById('currentTime').textContent=this.formatTime(s.position);document.getElementById('progressBar').style.width=`${(s.position/s.duration)*100}%`}}},1000); }
            async loadDynamicWeather() { navigator.geolocation.getCurrentPosition(async (pos)=>{try{const r=await fetch(`https://api.weatherapi.com/v1/current.json?key=${WEATHER_API_KEY}&q=${pos.coords.latitude},${pos.coords.longitude}`);if(!r.ok)return;const d=await r.json();if(d.current.is_day===0)document.body.classList.add('theme-night');if(d.current.condition.text.toLowerCase().includes('rain'))document.body.classList.add('weather-rain');}catch{}},()=>{if((new Date().getHours()<6||new Date().getHours()>19))document.body.classList.add('theme-night');}); }
        }
        
        document.addEventListener('DOMContentLoaded',function(){const sP=new SpotifyPlayer();document.getElementById('loginBtn').addEventListener('click',()=>sP.login());const aS={none:{name:'None',file:''},rain:{name:'Gentle Rain',file:'./assets/rain.mp3'},cafe:{name:'Coffee Shop',file:'./assets/cafe.mp3'},fire:{name:'Inazuma',file:'./assets/inazuma.mp3'}};const s1=document.getElementById('ambientSelect1'),l1=document.getElementById('ambientSlider1'),u1=document.getElementById('ambientAudio1');const s2=document.getElementById('ambientSelect2'),l2=document.getElementById('ambientSlider2'),u2=document.getElementById('ambientAudio2');function pS(s){for(const k in aS){const o=document.createElement('option');o.value=k;o.textContent=aS[k].name;s.appendChild(o);}}pS(s1);pS(s2);function sC(s,sl,a){function u(){const si=aS[s.value];a.volume=sl.value;const su=si.file?new URL(si.file,window.location.href).href:'';if(a.src!==su){a.src=su;if(su)a.load();}if(sl.value>0&&si.file&&a.paused){a.play().catch(()=>{});}else if(sl.value==0||!si.file){a.pause();}}s.addEventListener('change',u);sl.addEventListener('input',u);}sC(s1,l1,u1);sC(s2,l2,u2);});
    </script>
</body>
</html>
