<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>☕ Lo-Fi Café Spotify Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=DM+Sans:wght@300;400;500;600&family=Quicksand:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js for the Vibe Dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'cream': '#f5f1ec',
                        'latte-tan': '#d9cfc1',
                        'sage-green': '#c7d2c2',
                        'muted-plum': '#4a4e69',
                        'brown-gray': '#403d39',
                        'dusty-pink': '#f0a6ca'
                    },
                    fontFamily: {
                        'handwritten': ['Dancing Script', 'cursive'],
                        'sans': ['Open Sans', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        html, body {
            height: 100%;
            overflow: hidden; /* Prevent body scroll, let inner divs handle it */
        }
        body {
            background-color: #f5f1ec;
            background-image: linear-gradient(to bottom right, #f5f1ec, #d9cfc1, #c7d2c2);
            font-family: 'DM Sans', sans-serif;
            color: #403d39;
            transition: background-image 1s ease;
        }

        /* Dynamic Theme: Night */
        body.theme-night { background-image: linear-gradient(to bottom right, #4a4e69, #403d39, #2c2b28); color: #f5f1ec; }
        body.theme-night .blur-bg { background-color: rgba(0, 0, 0, 0.25); border: 1px solid rgba(255, 255, 255, 0.1); }
        body.theme-night .blur-bg h2, body.theme-night .blur-bg h3#userName { color: #f5f1ec; }
        body.theme-night .blur-bg .text-gray-600 { color: #d9cfc1; }
        body.theme-night .playlist-item:hover { background-color: rgba(245, 241, 236, 0.1); }
        
        .cafe-bg { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 200 200"><rect width="200" height="200" fill="%23F9F5EB"/><path d="M20,20 Q100,40 180,20 Q160,100 180,180 Q100,160 20,180 Q40,100 20,20 Z" fill="%23D2B48C" opacity="0.05"/></svg>'); background-size: cover; position: relative; overflow: hidden; }
        .rain { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1; display: none; }
        body.weather-rain .rain { display: block; }
        .drop { position: absolute; width: 1px; height: 20px; background: linear-gradient(to bottom, rgba(182, 216, 242, 0.3), rgba(182, 216, 242, 0.1)); animation: fall linear infinite; }
        @keyframes fall { to { transform: translateY(100vh); } }
        .vinyl { animation: spin 20s linear infinite; animation-play-state: paused; }
        .playing .vinyl { animation-play-state: running; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .progress-bar { height: 6px; border-radius: 3px; background: linear-gradient(90deg, #9DC183 0%, #D4A5A5 100%); transition: width 0.3s ease; }
        .playlist-item:hover { transform: translateX(5px); background-color: rgba(210, 180, 140, 0.2); }
        .blur-bg { backdrop-filter: blur(12px); background-color: rgba(255, 255, 255, 0.25); border: 1px solid rgba(255, 255, 255, 0.18); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15); }
        .plant { position: absolute; bottom: 0; z-index: -1; }
        .plant-1 { left: 5%; height: 120px; }
        .plant-2 { right: 10%; height: 90px; }
        .loading-spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #f0a6ca; border-radius: 50%; animation: spin 1s linear infinite; }
        .login-container { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-radius: 20px; padding: 40px; text-align: center; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }
        .spotify-btn { background: linear-gradient(45deg, #1DB954, #1ed760); color: white; padding: 12px 24px; border-radius: 25px; font-weight: 600; transition: all 0.3s ease; border: none; cursor: pointer; display: inline-flex; align-items: center; gap: 10px; }
        .spotify-btn:hover { background: linear-gradient(45deg, #1ed760, #1DB954); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(29, 185, 84, 0.3); }
        input[type="range"] { -webkit-appearance: none; appearance: none; background: transparent; cursor: pointer; }
        input[type="range"]::-webkit-slider-runnable-track { background: #d9cfc1; height: 0.5rem; border-radius: 0.25rem; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; margin-top: -4px; background-color: #f0a6ca; height: 1.25rem; width: 1.25rem; border-radius: 50%; }
        body.theme-night input[type="range"]::-webkit-slider-runnable-track { background: #4a4e69; }
    </style>
</head>
<body class="cafe-bg min-h-screen flex flex-col">
    <!-- Rain animation -->
    <div class="rain" id="rain"></div>
    
    <!-- Plants, etc. -->
    <div class="plant plant-1"><svg viewBox="0 0 64 128" xmlns="http://www.w3.org/2000/svg"><path d="M32,128 C10,100 15,70 20,50 C25,30 30,10 32,0 C34,10 39,30 44,50 C49,70 54,100 32,128 Z" fill="#9DC183"/></svg></div>
    <div class="plant plant-2"><svg viewBox="0 0 48 96" xmlns="http://www.w3.org/2000/svg"><path d="M24,96 C8,80 12,60 15,45 C18,30 21,15 24,0 C27,15 30,30 33,45 C36,60 40,80 24,96 Z" fill="#9DC183"/></svg></div>
    
    <!-- Login Screen -->
    <div id="loginScreen" class="fixed inset-0 flex items-center justify-center z-50">
        <div class="login-container max-w-md w-full mx-4">
            <div class="mb-6"><i class="fas fa-music text-6xl text-dusty-pink mb-4"></i><h1 class="font-handwritten text-4xl text-muted-plum mb-2">Lo-Fi Spotify Player</h1><p class="text-gray-600">Connect to Spotify to start your musical journey</p></div>
            <div id="loginContent"><button id="loginBtn" class="spotify-btn"><i class="fab fa-spotify text-xl"></i>Connect with Spotify</button><p class="text-sm text-gray-500 mt-4">We'll redirect you to Spotify to authorize access</p></div>
            <div id="loadingContent" class="hidden"><div class="loading-spinner mx-auto mb-4"></div><p class="text-gray-600">Connecting to Spotify...</p></div>
        </div>
    </div>
    
    <!-- Main App Container -->
    <div id="mainApp" class="hidden flex-col md:flex-row flex-grow max-w-7xl mx-auto w-full p-4 md:p-6" style="height: 100vh;">
        <!-- Sidebar -->
        <div class="w-full md:w-1/4 lg:w-1/5 flex flex-col mb-6 md:mb-0 md:mr-6">
            <!-- User Profile -->
            <div class="blur-bg rounded-2xl p-5 mb-6"><div class="flex items-center"><img id="userAvatar" class="w-16 h-16 rounded-xl object-cover" src="" alt="User Avatar"><div class="ml-4"><h3 id="userName" class="font-semibold">Loading...</h3><p id="userPlan" class="text-sm text-gray-600">Premium</p></div></div><button id="logoutBtn" class="mt-4 text-sm text-dusty-pink"><i class="fas fa-sign-out-alt mr-2"></i>Logout</button></div>
            <!-- Playlists -->
            <div class="blur-bg rounded-2xl p-5 flex-grow flex flex-col"><h2 class="font-handwritten text-2xl text-dusty-pink mb-4">Your Playlists</h2><div id="playlistContainer" class="space-y-2 max-h-96 overflow-y-auto"><div class="loading-spinner mx-auto"></div></div></div>
            <!-- Ambiance Mixer -->
            <div class="blur-bg rounded-2xl p-5 mt-6">
                <h2 class="font-handwritten text-2xl text-dusty-pink mb-3">Ambiance Mixer</h2>
                <div class="mb-4"><label for="ambientSelect1" class="text-sm font-medium">Channel 1</label><select id="ambientSelect1" class="w-full mt-1 p-2 rounded-lg bg-cream border border-latte-tan text-sm focus:outline-none focus:ring-2 focus:ring-dusty-pink"></select><input type="range" id="ambientSlider1" min="0" max="1" step="0.01" value="0" class="w-full mt-2"></div>
                <div><label for="ambientSelect2" class="text-sm font-medium">Channel 2</label><select id="ambientSelect2" class="w-full mt-1 p-2 rounded-lg bg-cream border border-latte-tan text-sm focus:outline-none focus:ring-2 focus:ring-dusty-pink"></select><input type="range" id="ambientSlider2" min="0" max="1" step="0.01" value="0" class="w-full mt-2"></div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="flex-grow flex flex-col overflow-y-auto" style="min-height: 0;">
            <!-- Now Playing Section -->
            <div class="blur-bg rounded-2xl p-6 mb-6 flex-shrink-0">
                <h1 class="font-quicksand text-3xl md:text-4xl text-center mb-6 tracking-wide">Now Playing</h1>
                <div class="flex flex-col md:flex-row items-center">
                    <div class="relative mb-6 md:mb-0 md:mr-8"><div class="vinyl relative w-48 h-48 md:w-56 md:h-56 mx-auto"><div class="absolute inset-0 rounded-full bg-gradient-to-br from-warm-brown to-dusty-pink flex items-center justify-center"><div class="absolute w-16 h-16 bg-black rounded-full"></div><div class="absolute w-6 h-6 bg-cream rounded-full"></div></div></div><img id="albumArt" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-40 h-40 md:w-48 md:h-48 rounded-xl object-cover" src="" alt="Album Art"></div>
                    <div class="text-center md:text-left flex-grow"><h2 id="trackName" class="font-semibold text-2xl md:text-3xl mb-2">No track playing</h2><p id="artistName" class="text-lg text-gray-600 mb-4">Select a track to start</p>
                        <div class="mb-4"><div class="w-full bg-gray-200 rounded-full h-2 mb-2"><div id="progressBar" class="progress-bar h-2 rounded-full" style="width: 0%"></div></div><div class="flex justify-between text-sm text-gray-600"><span id="currentTime">0:00</span><span id="totalTime">0:00</span></div></div>
                        <div class="flex justify-center md:justify-start items-center space-x-6"><button id="shuffleBtn" class="text-2xl text-dusty-pink"><i class="fas fa-random"></i></button><button id="prevBtn" class="text-2xl text-dusty-pink"><i class="fas fa-step-backward"></i></button><button id="playBtn" class="w-12 h-12 rounded-full bg-dusty-pink flex items-center justify-center text-white"><i class="fas fa-play"></i></button><button id="nextBtn" class="text-2xl text-dusty-pink"><i class="fas fa-step-forward"></i></button><button id="repeatBtn" class="text-2xl text-dusty-pink"><i class="fas fa-redo"></i></button></div>
                        <div class="mt-6 flex items-center justify-between"><div class="flex items-center"><i class="fas fa-volume-down text-dusty-pink mr-3"></i><input type="range" id="volumeSlider" class="w-32" min="0" max="100" value="50"></div><button id="connectBtn" class="text-2xl text-dusty-pink" title="Connect to a device"><i class="fas fa-computer"></i></button></div>
                    </div>
                </div>
            </div>
            
            <!-- Search Section -->
            <div class="blur-bg rounded-2xl p-6 mb-6 flex-shrink-0">
                <h2 class="font-handwritten text-2xl text-dusty-pink mb-4">Search Music</h2>
                <div class="flex gap-4 mb-4"><input type="text" id="searchInput" placeholder="Search for tracks, artists, or albums..." class="flex-grow px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-dusty-pink"><button id="searchBtn" class="bg-dusty-pink text-white px-6 py-2 rounded-lg"><i class="fas fa-search"></i></button></div>
                <div id="searchResults" class="space-y-2 max-h-64 overflow-y-auto"></div>
            </div>
            
            <!-- Vibe Dashboard -->
            <div class="blur-bg rounded-2xl p-6 mb-6 flex-shrink-0">
                <h2 class="font-handwritten text-2xl text-dusty-pink mb-4">Your Vibe Dashboard</h2>
                <div id="vibeChartContainer" class="relative grid place-items-center" style="height:300px">
                    <div class="loading-spinner row-start-1 col-start-1"></div>
                    <canvas id="vibeChart" class="row-start-1 col-start-1"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Pop-out Button & Device Modal -->
    <button id="popoutBtn" class="hidden fixed bottom-6 left-6 bg-dusty-pink text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg"><i class="fas fa-external-link-alt"></i></button>
    <div id="devicesModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"><div class="bg-cream rounded-2xl shadow-xl p-6 w-full max-w-sm"><h2 class="font-handwritten text-2xl text-muted-plum mb-4">Connect to a device</h2><div id="deviceList" class="space-y-3"></div><button id="closeDevicesModalBtn" class="mt-6 w-full bg-dusty-pink text-white py-2 rounded-lg">Close</button></div></div>
    
    <!-- Generic Ambient Audio Players -->
    <audio id="ambientAudio1" loop></audio>
    <audio id="ambientAudio2" loop></audio>

    <script>
        // =================================================================================
        // API CONFIGURATION - IMPORTANT!
        // =================================================================================
        const CLIENT_ID = '1d19feb1d43040d7bb13ddea90fc6468';
        const REDIRECT_URI = 'https://akamai17.github.io/lofi-cafe/';
        const WEATHER_API_KEY = 'e4cf7e3f782e4d81b6b02628250907';
        // =================================================================================
        
        const SCOPES = ['user-read-private','user-read-email','user-read-playback-state','user-modify-playback-state','user-read-currently-playing','streaming','playlist-read-private','playlist-read-collaborative','user-top-read','user-read-recently-played'].join(' ');
        async function generateCodeChallenge(codeVerifier) { const data = new TextEncoder().encode(codeVerifier); const digest = await window.crypto.subtle.digest('SHA-256', data); return btoa(String.fromCharCode.apply(null, [...new Uint8Array(digest)])).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, ''); }
        
        class SpotifyPlayer {
            constructor() { this.accessToken = null; this.player = null; this.deviceId = null; this.currentTrack = null; this.isPlaying = false; this.vibeChart = null; this.vibeData = null; this.init(); }
            async init() { const params = new URLSearchParams(window.location.search); const code = params.get('code'); if (code) { document.getElementById('loginContent').classList.add('hidden'); document.getElementById('loadingContent').classList.remove('hidden'); document.getElementById('loginScreen').classList.remove('hidden'); await this.getAccessToken(code); window.history.replaceState({}, document.title, window.location.pathname); await this.initializeApp(); } else { const storedToken = sessionStorage.getItem('spotify_token'); if (storedToken) { this.accessToken = storedToken; await this.initializeApp(); } else { this.showLoginScreen(); } } }
            async getAccessToken(code) { const codeVerifier = sessionStorage.getItem('spotify_code_verifier'); if (!codeVerifier) { this.logout(); return; } try { const response = await fetch('https://accounts.spotify.com/api/token', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: new URLSearchParams({ client_id: CLIENT_ID, grant_type: 'authorization_code', code: code, redirect_uri: REDIRECT_URI, code_verifier: codeVerifier }), }); if (!response.ok) throw new Error('Failed to fetch access token'); const data = await response.json(); this.accessToken = data.access_token; sessionStorage.setItem('spotify_token', this.accessToken); } catch (error) { console.error('Error getting access token:', error); this.logout(); } }
            async login() { const codeVerifier = btoa(window.crypto.getRandomValues(new Uint8Array(32)).toString()).substring(0, 128); sessionStorage.setItem('spotify_code_verifier', codeVerifier); const codeChallenge = await generateCodeChallenge(codeVerifier); const authUrl = new URL('https://accounts.spotify.com/authorize'); authUrl.search = new URLSearchParams({ client_id: CLIENT_ID, response_type: 'code', redirect_uri: REDIRECT_URI, scope: SCOPES, code_challenge_method: 'S256', code_challenge: codeChallenge }).toString(); window.location.href = authUrl.toString(); }
            logout() { sessionStorage.removeItem('spotify_token'); sessionStorage.removeItem('spotify_code_verifier'); this.accessToken = null; if (this.player) this.player.disconnect(); window.location.href = window.location.origin + window.location.pathname; }
            showLoginScreen() { document.getElementById('loginScreen').classList.remove('hidden'); document.getElementById('mainApp').classList.add('hidden'); document.getElementById('popoutBtn').classList.add('hidden'); }
            
            // --- INITIALIZE APP (RESILIENT VERSION) ---
            async initializeApp() {
                document.getElementById('loginScreen').classList.add('hidden'); document.getElementById('mainApp').classList.remove('hidden'); document.getElementById('mainApp').classList.add('flex'); document.getElementById('popoutBtn').classList.remove('hidden');
                
                this.setupEventListeners();
                this.startProgressUpdater();

                // Call all loading functions. They will handle their own errors.
                this.loadUserProfile();
                this.loadPlaylists();
                this.initializeWebPlayback();
                this.fetchVibeData();
                this.loadDynamicWeather();
            }
            
            async makeSpotifyRequest(endpoint, options = {}) { const response = await fetch(`https://api.spotify.com/v1${endpoint}`, { ...options, headers: { 'Authorization': `Bearer ${this.accessToken}`, 'Content-Type': 'application/json', ...options.headers } }); if (!response.ok) { if(response.status === 401) this.logout(); throw new Error(`Spotify API error: ${response.status}`); } const text = await response.text(); return text ? JSON.parse(text) : {}; }
            
            async loadUserProfile() { try { const profile = await this.makeSpotifyRequest('/me'); document.getElementById('userName').textContent = profile.display_name || 'Spotify User'; document.getElementById('userPlan').textContent = profile.product || 'Free'; if (profile.images && profile.images.length > 0) { document.getElementById('userAvatar').src = profile.images[0].url; } } catch (error) { console.error('Error loading user profile:', error); } }
            async loadPlaylists() { try { const playlists = await this.makeSpotifyRequest('/me/playlists?limit=50'); const container = document.getElementById('playlistContainer'); container.innerHTML = ''; playlists.items.forEach(playlist => { const el = document.createElement('div'); el.className = 'playlist-item cursor-pointer p-3 rounded-xl transition-all'; el.innerHTML = `<p class="font-medium truncate">${playlist.name}</p><p class="text-sm text-gray-600">${playlist.tracks.total} songs</p>`; el.addEventListener('click', () => this.playItem(playlist.uri)); container.appendChild(el); }); } catch (error) { console.error('Error loading playlists:', error); document.getElementById('playlistContainer').innerHTML = `<p class="text-red-500 text-sm">Could not load playlists.</p>`; } }
            async playItem(uri) { if (!this.deviceId) { alert('Player not ready.'); return; } try { const body = uri.includes(':playlist:') || uri.includes(':album:') ? { context_uri: uri } : { uris: [uri] }; await this.makeSpotifyRequest(`/me/player/play?device_id=${this.deviceId}`, { method: 'PUT', body: JSON.stringify(body) }); } catch (error) { console.error('Error playing item:', error); } }
            
            async initializeWebPlayback() { try { await new Promise(resolve => { if (window.Spotify) resolve(); else { const script = document.createElement('script'); script.src = 'https://sdk.scdn.co/spotify-player.js'; script.async = true; document.head.appendChild(script); window.onSpotifyWebPlaybackSDKReady = resolve; } }); this.player = new Spotify.Player({ name: 'Lo-Fi Café Player', getOAuthToken: cb => { cb(this.accessToken); }, volume: 0.5 }); this.player.addListener('ready', ({ device_id }) => { this.deviceId = device_id; }); this.player.addListener('not_ready', ({ device_id }) => console.log('Device offline', device_id)); this.player.addListener('player_state_changed', (state) => { if (state) this.updatePlayerState(state); }); await this.player.connect(); } catch (error) { console.error('Could not initialize Web Playback SDK', error);}}
            
            updatePlayerState(state) {
                if (!state) { this.isPlaying = false; document.getElementById('trackName').textContent = 'No track playing'; document.getElementById('artistName').textContent = 'Select a track to start'; document.getElementById('albumArt').src = ''; document.getElementById('playBtn').innerHTML = '<i class="fas fa-play"></i>'; document.querySelector('.vinyl').classList.remove('playing'); return; }
                const track = state.track_window.current_track; this.currentTrack = track; this.isPlaying = !state.paused; document.getElementById('trackName').textContent = track.name; document.getElementById('artistName').textContent = track.artists.map(a => a.name).join(', '); document.getElementById('albumArt').src = track.album.images[0]?.url || ''; document.getElementById('totalTime').textContent = this.formatTime(track.duration_ms); document.getElementById('currentTime').textContent = this.formatTime(state.position); document.getElementById('progressBar').style.width = `${(state.position / track.duration_ms) * 100}%`; document.getElementById('playBtn').innerHTML = this.isPlaying ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>'; document.querySelector('.vinyl').classList.toggle('playing', this.isPlaying);
            }
            
            formatTime(ms) { const m = Math.floor(ms / 60000); const s = Math.floor((ms % 60000) / 1000); return `${m}:${s.toString().padStart(2, '0')}`; }
            
            async search(query) { try { const results = await this.makeSpotifyRequest(`/search?q=${encodeURIComponent(query)}&type=track&limit=10`); const container = document.getElementById('searchResults'); container.innerHTML = ''; results.tracks.items.forEach(track => { const el = document.createElement('div'); el.className = 'flex items-center p-3 rounded-lg hover:bg-gray-100 cursor-pointer'; el.innerHTML = `<img src="${track.album.images[2]?.url || ''}" class="w-12 h-12 rounded-lg mr-3"><div class="flex-grow overflow-hidden"><p class="font-medium truncate">${track.name}</p><p class="text-sm text-gray-600 truncate">${track.artists.map(a => a.name).join(', ')}</p></div><button class="text-dusty-pink play-search-result flex-shrink-0 ml-2"><i class="fas fa-play"></i></button>`; el.querySelector('.play-search-result').addEventListener('click', (e) => { e.stopPropagation(); this.playItem(track.uri); }); container.appendChild(el); }); } catch (error) { console.error('Error searching:', error); } }
            async showDeviceList() { try { const res = await this.makeSpotifyRequest('/me/player/devices'); const listEl = document.getElementById('deviceList'); const modalEl = document.getElementById('devicesModal'); listEl.innerHTML = ''; if (res.devices.length === 0) { listEl.innerHTML = '<p>No active devices found.</p>'; } else { res.devices.forEach(device => { const el = document.createElement('div'); el.className = 'flex items-center p-3 rounded-lg hover:bg-latte-tan cursor-pointer'; let icon = 'fa-computer'; if (device.type.toLowerCase() === 'smartphone') icon = 'fa-mobile-screen-button'; if (device.type.toLowerCase() === 'speaker') icon = 'fa-volume-high'; el.innerHTML = `<i class="fas ${icon} text-muted-plum w-6 text-center"></i><span class="ml-4 font-medium">${device.name}</span>${device.is_active ? '<span class="ml-auto text-xs font-bold text-green-600">ACTIVE</span>' : ''}`; el.addEventListener('click', () => this.transferPlayback(device.id)); listEl.appendChild(el); }); } modalEl.classList.remove('hidden'); } catch (error) { console.error('Error fetching devices:', error); } }
            async transferPlayback(deviceId) { try { await this.makeSpotifyRequest('/me/player', { method: 'PUT', body: JSON.stringify({ device_ids: [deviceId], play: true }) }); document.getElementById('devicesModal').classList.add('hidden'); } catch (error) { console.error('Error transferring playback:', error); } }

            async fetchVibeData() {
                try {
                    const topTracks = await this.makeSpotifyRequest('/me/top/tracks?limit=50&time_range=short_term');
                    if (topTracks.items.length === 0) { this.vibeData = null; this.renderVibeChart(); return; }
                    const trackIds = topTracks.items.map(track => track.id);
                    const audioFeatures = await this.makeSpotifyRequest(`/audio-features?ids=${trackIds.join(',')}`);
                    const avgFeatures = { danceability: 0, energy: 0, acousticness: 0, instrumentalness: 0, valence: 0 };
                    const featureKeys = Object.keys(avgFeatures);
                    let validFeaturesCount = 0;
                    audioFeatures.audio_features.forEach(feature => { if (feature) { validFeaturesCount++; featureKeys.forEach(key => avgFeatures[key] += feature[key]); } });
                    featureKeys.forEach(key => avgFeatures[key] /= validFeaturesCount);
                    this.vibeData = avgFeatures;
                    this.renderVibeChart();
                } catch (error) { console.error('Error fetching vibe dashboard:', error); document.getElementById('vibeChartContainer').innerHTML = '<p class="text-center text-red-500">Could not load vibe data.</p>'; }
            }

            renderVibeChart() {
                const container = document.getElementById('vibeChartContainer');
                const spinner = container.querySelector('.loading-spinner');
                if (spinner) spinner.style.display = 'none';
                if (this.vibeChart) { this.vibeChart.destroy(); }
                if (!this.vibeData) { container.innerHTML = '<p class="text-center">Not enough listening data.</p>'; return; }
                
                const ctx = document.getElementById('vibeChart').getContext('2d');
                const isNightMode = document.body.classList.contains('theme-night');
                const chartTextColor = isNightMode ? '#f5f1ec' : '#403d39';
                const gridColor = isNightMode ? 'rgba(245, 241, 236, 0.2)' : 'rgba(64, 61, 57, 0.2)';

                this.vibeChart = new Chart(ctx, { type: 'radar', data: { labels: ['Danceability', 'Energy', 'Acoustic', 'Instrumental', 'Positivity'], datasets: [{ label: 'Your Current Vibe', data: Object.values(this.vibeData), fill: true, backgroundColor: 'rgba(240, 166, 202, 0.2)', borderColor: 'rgb(240, 166, 202)', pointBackgroundColor: 'rgb(240, 166, 202)', pointBorderColor: '#fff', pointHoverBackgroundColor: '#fff', pointHoverBorderColor: 'rgb(240, 166, 202)' }] },
                    options: { maintainAspectRatio: false, scales: { r: { angleLines: { color: gridColor }, grid: { color: gridColor }, pointLabels: { font: { size: 12 }, color: chartTextColor }, suggestedMin: 0, suggestedMax: 1 } }, plugins: { legend: { display: false } } }
                });
            }
            
            async loadDynamicWeather() {
                try {
                    if (WEATHER_API_KEY === 'YOUR_WEATHERAPI_COM_KEY_HERE') { console.warn("WeatherAPI.com key not set."); return; }
                    navigator.geolocation.getCurrentPosition(async (position) => {
                        const { latitude, longitude } = position.coords;
                        const res = await fetch(`https://api.weatherapi.com/v1/current.json?key=${WEATHER_API_KEY}&q=${latitude},${longitude}`);
                        if (!res.ok) return;
                        const weatherData = await res.json();
                        if (weatherData.current.is_day === 0) document.body.classList.add('theme-night');
                        const conditionText = weatherData.current.condition.text.toLowerCase();
                        if (conditionText.includes('rain') || conditionText.includes('drizzle') || conditionText.includes('thunder')) document.body.classList.add('weather-rain');
                        this.renderVibeChart(); // Re-render chart with correct theme colors
                    }, (error) => {
                        console.error("Geolocation permission denied.", error);
                        const hour = new Date().getHours();
                        if (hour < 6 || hour > 19) document.body.classList.add('theme-night');
                        this.renderVibeChart(); // Re-render chart anyway
                    });
                } catch (e) { console.error("Could not fetch weather data.", e); }
            }
            
            async togglePlay() { if (this.player) await this.player.togglePlay(); }
            async nextTrack() { if (this.player) await this.player.nextTrack(); }
            async previousTrack() { if (this.player) await this.player.previousTrack(); }
            async setVolume(volume) { if (this.player) await this.player.setVolume(volume / 100); }
            async getCurrentPlayback() { if (this.isPlaying && this.player) { const state = await this.player.getCurrentState(); if(state) { document.getElementById('currentTime').textContent = this.formatTime(state.position); document.getElementById('progressBar').style.width = `${(state.position / state.duration) * 100}%`; } } }
            
            setupEventListeners() {
                document.getElementById('playBtn').addEventListener('click', () => this.togglePlay()); document.getElementById('prevBtn').addEventListener('click', () => this.previousTrack()); document.getElementById('nextBtn').addEventListener('click', () => this.nextTrack()); document.getElementById('volumeSlider').addEventListener('input', (e) => this.setVolume(e.target.value));
                const searchAction = () => { const query = document.getElementById('searchInput').value; if (query) this.search(query); };
                document.getElementById('searchBtn').addEventListener('click', searchAction); document.getElementById('searchInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') searchAction(); });
                document.getElementById('logoutBtn').addEventListener('click', () => this.logout()); document.getElementById('popoutBtn').addEventListener('click', () => alert("Miniplayer feature is under construction!"));
                document.getElementById('connectBtn').addEventListener('click', () => this.showDeviceList()); document.getElementById('closeDevicesModalBtn').addEventListener('click', () => { document.getElementById('devicesModal').classList.add('hidden'); });
            }
            
            startProgressUpdater() { setInterval(() => this.getCurrentPlayback(), 1000); }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            createRain();
            const spotifyPlayer = new SpotifyPlayer();
            document.getElementById('loginBtn').addEventListener('click', () => { if (CLIENT_ID === 'YOUR_SPOTIFY_CLIENT_ID' || !CLIENT_ID) { alert('Spotify Client ID not set!'); return; } document.getElementById('loginContent').classList.add('hidden'); document.getElementById('loadingContent').classList.remove('hidden'); spotifyPlayer.login(); });
            const ambientSounds = { none: { name: 'None', file: '' }, rain: { name: 'Gentle Rain', file: './assets/rain.mp3' }, cafe: { name: 'Coffee Shop', file: './assets/cafe.mp3' }, fire: { name: 'Inazuma', file: './assets/inazuma.mp3' }};
            const select1 = document.getElementById('ambientSelect1'); const slider1 = document.getElementById('ambientSlider1'); const audio1 = document.getElementById('ambientAudio1');
            const select2 = document.getElementById('ambientSelect2'); const slider2 = document.getElementById('ambientSlider2'); const audio2 = document.getElementById('ambientAudio2');
            function populateSelect(selectElement) { for (const key in ambientSounds) { const option = document.createElement('option'); option.value = key; option.textContent = ambientSounds[key].name; selectElement.appendChild(option); } }
            populateSelect(select1); populateSelect(select2);
            function setupChannel(select, slider, audio) {
                function updateAudio() {
                    const selectedSoundKey = select.value;
                    const soundInfo = ambientSounds[selectedSoundKey];
                    const currentVolume = slider.value;
                    if (audio.src !== (new URL(soundInfo.file, window.location.href)).href) { audio.src = soundInfo.file; audio.load(); }
                    audio.volume = currentVolume;
                    if (currentVolume > 0 && soundInfo.file && audio.paused) { audio.play().catch(e => console.error("Audio play failed:", e)); } 
                    else if (currentVolume == 0 || !soundInfo.file) { audio.pause(); }
                }
                select.addEventListener('change', updateAudio);
                slider.addEventListener('input', updateAudio);
            }
            setupChannel(select1, slider1, audio1);
            setupChannel(select2, slider2, audio2);
        });

        function createRain() { const rainContainer = document.getElementById('rain'); if (!rainContainer) return; for (let i = 0; i < 100; i++) { const drop = document.createElement('div'); drop.className = 'drop'; drop.style.left = `${Math.random() * 100}%`; drop.style.animationDuration = `${1 + Math.random() * 2}s`; drop.style.animationDelay = `${Math.random() * 5}s`; rainContainer.appendChild(drop); } }
    </script>
</body>
</html>
