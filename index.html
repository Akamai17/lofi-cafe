<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>☕ Lo-Fi Café Spotify Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=DM+Sans:wght@300;400;500;600&family=Quicksand:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'cream': '#f5f1ec',
                        'latte-tan': '#d9cfc1',
                        'sage-green': '#c7d2c2',
                        'muted-plum': '#4a4e69',
                        'brown-gray': '#403d39',
                        'dusty-pink': '#f0a6ca'
                    },
                    fontFamily: {
                        'handwritten': ['Dancing Script', 'cursive'],
                        'sans': ['Open Sans', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #f5f1ec;
            background-image: linear-gradient(to bottom right, #f5f1ec, #d9cfc1, #c7d2c2);
            font-family: 'DM Sans', sans-serif;
            overflow-x: hidden;
            color: #403d39;
        }
        
        .cafe-bg {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 200 200"><rect width="200" height="200" fill="%23F9F5EB"/><path d="M20,20 Q100,40 180,20 Q160,100 180,180 Q100,160 20,180 Q40,100 20,20 Z" fill="%23D2B48C" opacity="0.05"/></svg>');
            background-size: cover;
            position: relative;
            overflow: hidden;
        }
        
        .rain {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
        
        .drop {
            position: absolute;
            width: 1px;
            height: 20px;
            background: linear-gradient(to bottom, rgba(182, 216, 242, 0.3), rgba(182, 216, 242, 0.1));
            animation: fall linear infinite;
        }
        
        @keyframes fall {
            to { transform: translateY(100vh); }
        }
        
        .vinyl {
            animation: spin 20s linear infinite;
            animation-play-state: paused;
        }
        
        .playing .vinyl {
            animation-play-state: running;
        }
        
        @keyframes spin {
            100% { transform: rotate(360deg); }
        }
        
        .progress-bar {
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(90deg, #9DC183 0%, #D4A5A5 100%);
            transition: width 0.3s ease;
        }
        
        .playlist-item:hover {
            transform: translateX(5px);
            background-color: rgba(210, 180, 140, 0.2);
        }
        
        .popup-animation {
            animation: popup 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            transform-origin: bottom right;
        }

        @keyframes popup {
            0% {
                transform: scale(0.8) translateY(20px);
                opacity: 0;
            }
            100% {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }
        
        .lyrics-container {
            mask-image: linear-gradient(to bottom, black 80%, transparent 100%);
        }
        
        .blur-bg {
            backdrop-filter: blur(12px);
            background-color: rgba(255, 255, 255, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }
        
        .plant {
            position: absolute;
            bottom: 0;
            z-index: -1;
        }
        
        .plant-1 {
            left: 5%;
            height: 120px;
        }
        
        .plant-2 {
            right: 10%;
            height: 90px;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #f0a6ca;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .login-container {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .spotify-btn {
            background: linear-gradient(45deg, #1DB954, #1ed760);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .spotify-btn:hover {
            background: linear-gradient(45deg, #1ed760, #1DB954);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(29, 185, 84, 0.3);
        }
    </style>
</head>
<body class="cafe-bg min-h-screen flex flex-col">
    <!-- Rain animation -->
    <div class="rain" id="rain"></div>
    
    <!-- Plants -->
    <div class="plant plant-1">
        <svg viewBox="0 0 64 128" xmlns="http://www.w3.org/2000/svg">
            <path d="M32,128 C10,100 15,70 20,50 C25,30 30,10 32,0 C34,10 39,30 44,50 C49,70 54,100 32,128 Z" fill="#9DC183"/>
        </svg>
    </div>
    <div class="plant plant-2">
        <svg viewBox="0 0 48 96" xmlns="http://www.w3.org/2000/svg">
            <path d="M24,96 C8,80 12,60 15,45 C18,30 21,15 24,0 C27,15 30,30 33,45 C36,60 40,80 24,96 Z" fill="#9DC183"/>
        </svg>
    </div>
    
    <!-- Login Screen -->
    <div id="loginScreen" class="fixed inset-0 flex items-center justify-center z-50">
        <div class="login-container max-w-md w-full mx-4">
            <div class="mb-6">
                <i class="fas fa-music text-6xl text-dusty-pink mb-4"></i>
                <h1 class="font-handwritten text-4xl text-muted-plum mb-2">Lo-Fi Spotify Player Indev</h1>
                <p class="text-gray-600">Connect to Spotify to start your musical journey</p>
            </div>
            
            <div id="loginContent">
                <button id="loginBtn" class="spotify-btn">
                    <i class="fab fa-spotify text-xl"></i>
                    Connect with Spotify
                </button>
                <p class="text-sm text-gray-500 mt-4">
                    We'll redirect you to Spotify to authorize access to your account
                </p>
            </div>
            
            <div id="loadingContent" class="hidden">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p class="text-gray-600">Connecting to Spotify...</p>
            </div>
        </div>
    </div>
    
    <!-- Main App Container -->
    <div id="mainApp" class="hidden flex-col md:flex-row flex-grow max-w-7xl mx-auto w-full p-4 md:p-6">
        <!-- Sidebar -->
        <div class="w-full md:w-1/4 lg:w-1/5 flex flex-col mb-6 md:mb-0 md:mr-6">
            <!-- User Profile -->
            <div class="blur-bg rounded-2xl p-5 mb-6">
                <div class="flex items-center">
                    <img id="userAvatar" class="w-16 h-16 rounded-xl object-cover" src="" alt="User Avatar">
                    <div class="ml-4">
                        <h3 id="userName" class="font-semibold text-warm-brown">Loading...</h3>
                        <p id="userPlan" class="text-sm text-gray-600">Premium Member</p>
                    </div>
                </div>
                <button id="logoutBtn" class="mt-4 text-sm text-dusty-pink hover:text-warm-brown">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </button>
            </div>
            
            <!-- Playlists -->
            <div class="blur-bg rounded-2xl p-5 flex-grow">
                <h2 class="font-handwritten text-2xl text-dusty-pink mb-4">Your Playlists</h2>
                <div id="playlistContainer" class="space-y-2">
                    <div class="loading-spinner mx-auto"></div>
                </div>
            </div>
            
            <!-- Mood Board -->
            <div class="blur-bg rounded-2xl p-5 mt-6">
                <h2 class="font-handwritten text-2xl text-dusty-pink mb-3">Current Mood</h2>
                <div class="flex items-center">
                    <i class="fas fa-cloud-sun text-3xl text-sage mr-3"></i>
                    <div>
                        <p class="font-medium">Partly Cloudy</p>
                        <p class="text-sm">Perfect for relaxing</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="flex-grow flex flex-col">
            <!-- Now Playing Section -->
            <div class="blur-bg rounded-2xl p-6 mb-6">
                <h1 class="font-quicksand text-3xl md:text-4xl text-center text-muted-plum mb-6 tracking-wide">Now Playing</h1>
                
                <div class="flex flex-col md:flex-row items-center">
                    <!-- Album Art -->
                    <div class="relative mb-6 md:mb-0 md:mr-8">
                        <div class="vinyl relative w-48 h-48 md:w-56 md:h-56 mx-auto">
                            <div class="absolute inset-0 rounded-full bg-gradient-to-br from-warm-brown to-dusty-pink flex items-center justify-center">
                                <div class="absolute w-16 h-16 bg-black rounded-full"></div>
                                <div class="absolute w-6 h-6 bg-cream rounded-full"></div>
                            </div>
                        </div>
                        <img id="albumArt" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-40 h-40 md:w-48 md:h-48 rounded-xl object-cover" src="" alt="Album Art">
                    </div>
                    
                    <!-- Track Info -->
                    <div class="text-center md:text-left flex-grow">
                        <h2 id="trackName" class="font-semibold text-2xl md:text-3xl mb-2">No track playing</h2>
                        <p id="artistName" class="text-lg text-gray-700 mb-4">Select a track to start</p>
                        
                        <!-- Progress Bar -->
                        <div class="mb-4">
                            <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                                <div id="progressBar" class="progress-bar h-2 rounded-full" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between text-sm text-gray-600">
                                <span id="currentTime">0:00</span>
                                <span id="totalTime">0:00</span>
                            </div>
                        </div>
                        
                        <!-- Controls -->
                        <div class="flex justify-center md:justify-start items-center space-x-6">
                            <button id="shuffleBtn" class="text-2xl text-dusty-pink hover:text-warm-brown transition-colors">
                                <i class="fas fa-random"></i>
                            </button>
                            <button id="prevBtn" class="text-2xl text-dusty-pink hover:text-warm-brown transition-colors">
                                <i class="fas fa-step-backward"></i>
                            </button>
                            <button id="playBtn" class="w-12 h-12 rounded-full bg-dusty-pink flex items-center justify-center text-white hover:bg-warm-brown transition-colors">
                                <i class="fas fa-play"></i>
                            </button>
                            <button id="nextBtn" class="text-2xl text-dusty-pink hover:text-warm-brown transition-colors">
                                <i class="fas fa-step-forward"></i>
                            </button>
                            <button id="repeatBtn" class="text-2xl text-dusty-pink hover:text-warm-brown transition-colors">
                                <i class="fas fa-redo"></i>
                            </button>
                        </div>
                        
                        <!-- Volume Control -->
                        <div class="mt-6 flex items-center">
                            <i class="fas fa-volume-down text-dusty-pink mr-3"></i>
                            <input type="range" id="volumeSlider" class="w-32" min="0" max="100" value="50">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Search Section -->
            <div class="blur-bg rounded-2xl p-6 mb-6">
                <h2 class="font-handwritten text-2xl text-dusty-pink mb-4">Search Music</h2>
                <div class="flex gap-4 mb-4">
                    <input type="text" id="searchInput" placeholder="Search for tracks, artists, or albums..." 
                           class="flex-grow px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-dusty-pink">
                    <button id="searchBtn" class="bg-dusty-pink text-white px-6 py-2 rounded-lg hover:bg-warm-brown transition-colors">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div id="searchResults" class="space-y-2 max-h-64 overflow-y-auto"></div>
            </div>
            
            <!-- Stats Section -->
            <div class="blur-bg rounded-2xl p-6">
                <h2 class="font-handwritten text-2xl text-dusty-pink mb-4">Your Listening Stats</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-sage-green rounded-xl p-4 text-white">
                        <h3 class="font-semibold mb-2">Top Genre</h3>
                        <p id="topGenre" class="text-lg">Loading...</p>
                    </div>
                    <div class="bg-muted-plum rounded-xl p-4 text-white">
                        <h3 class="font-semibold mb-2">Top Artist</h3>
                        <p id="topArtist" class="text-lg">Loading...</p>
                    </div>
                    <div class="bg-dusty-pink rounded-xl p-4 text-white">
                        <h3 class="font-semibold mb-2">Followers</h3>
                        <p id="followers" class="text-lg">Loading...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Pop-out Button -->
    <button id="popoutBtn" class="hidden fixed bottom-6 left-6 bg-dusty-pink text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg hover:bg-warm-brown transition-colors">
        <i class="fas fa-external-link-alt"></i>
    </button>
    
    <script>
        // =================================================================================
        // IMPORTANT: SPOTIFY API CONFIGURATION
        // =================================================================================
        // 1. Get your Client ID from the Spotify Developer Dashboard:
        //    https://developer.spotify.com/dashboard/
        // 2. Replace 'YOUR_SPOTIFY_CLIENT_ID' with your actual Client ID.
        const CLIENT_ID = '128562300fcf4685b47cc5ac1df3c28f'; // <-- PASTE YOUR CLIENT ID HERE

        // 3. Set your Redirect URI. This MUST EXACTLY MATCH the URI you add to your
        //    app's settings in the Spotify Developer Dashboard.
        //    - If you are running this file locally with a tool like VS Code's Live Server,
        //      your URI might be: http://127.0.0.1:5500/your_file_name.html
        //    - If you are hosting it, use the full hosted URL.
        const REDIRECT_URI = window.location.origin + window.location.pathname;

        // 4. In your Spotify App settings, add the URI from step 3 to the
        //    "Redirect URIs" section.
        // =================================================================================
        
        const SCOPES = [
            'user-read-private',
            'user-read-email',
            'user-read-playback-state',
            'user-modify-playback-state',
            'user-read-currently-playing',
            'streaming',
            'playlist-read-private',
            'playlist-read-collaborative',
            'user-top-read',
            'user-read-recently-played'
        ].join(' ');
        
        class SpotifyPlayer {
            constructor() {
                this.accessToken = null;
                this.player = null;
                this.deviceId = null;
                this.currentTrack = null;
                this.isPlaying = false;
                this.init();
            }
            
            async init() {
                // Check if we have a token from redirect
                const token = this.getTokenFromUrl();
                if (token) {
                    this.accessToken = token;
                    window.history.replaceState({}, document.title, window.location.pathname);
                    await this.initializeApp();
                } else {
                    // Check for stored token
                    const storedToken = sessionStorage.getItem('spotify_token');
                    if (storedToken) {
                        this.accessToken = storedToken;
                        await this.initializeApp();
                    } else {
                        this.showLoginScreen();
                    }
                }
            }
            
            getTokenFromUrl() {
                const hash = window.location.hash.substring(1);
                const params = new URLSearchParams(hash);
                const token = params.get('access_token');
                if (token) {
                    sessionStorage.setItem('spotify_token', token);
                    return token;
                }
                return null;
            }
            
            showLoginScreen() {
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
            }
            
            login() {
                // This is the OAuth2 Implicit Grant Flow.
                // It redirects the user to Spotify to authorize the app.
                const authUrl = `https://accounts.spotify.com/authorize?client_id=${CLIENT_ID}&response_type=token&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(SCOPES)}`;
                window.location.href = authUrl;
            }
            
            logout() {
                sessionStorage.removeItem('spotify_token');
                this.accessToken = null;
                if (this.player) {
                    this.player.disconnect();
                }
                this.showLoginScreen();
            }
            
            async initializeApp() {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden'); // Ensure main app is visible
                document.getElementById('mainApp').classList.add('flex');
                document.getElementById('popoutBtn').classList.remove('hidden');
                
                try {
                    await this.loadUserProfile();
                    await this.loadPlaylists();
                    await this.loadTopTracks();
                    await this.initializeWebPlayback();
                    this.setupEventListeners();
                    this.startProgressUpdater();
                } catch (error) {
                    console.error('Error initializing app:', error);
                    // If the token is expired or invalid, Spotify API returns a 401 error.
                    if (error.message.includes('401')) {
                         alert('Your session has expired. Please log in again.');
                         this.logout();
                    } else {
                        alert('Failed to initialize Spotify connection. Please try logging in again.');
                        this.logout();
                    }
                }
            }
            
            async makeSpotifyRequest(endpoint, options = {}) {
                const response = await fetch(`https://api.spotify.com/v1${endpoint}`, {
                    ...options,
                    headers: {
                        'Authorization': `Bearer ${this.accessToken}`,
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Spotify API error: ${response.status}`);
                }
                // Handle cases where the response might be empty (e.g., PUT requests with no content)
                const text = await response.text();
                return text ? JSON.parse(text) : {};
            }
            
            async loadUserProfile() {
                try {
                    const profile = await this.makeSpotifyRequest('/me');
                    document.getElementById('userName').textContent = profile.display_name || 'Spotify User';
                    document.getElementById('userPlan').textContent = profile.product || 'Free';
                    document.getElementById('followers').textContent = profile.followers?.total || '0';
                    
                    if (profile.images && profile.images.length > 0) {
                        document.getElementById('userAvatar').src = profile.images[0].url;
                    } else {
                        document.getElementById('userAvatar').src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiByeD0iMTIiIGZpbGw9IiNmM2Y0ZjYiLz4KPHN2ZyB4PSIxNiIgeT0iMTYiIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSIjOWNhM2FmIj4KPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGZpbGw9Im5vbmUiIHZpZXdCb3g9IjAgMCAyNCAyNCIgc3Ryb2tlLXdpZHRoPSIxLjUiIHN0cm9rZT0iY3VycmVudENvbG9yIiBjbGFzcz0idy02IGgtNiI+CiAgPHBhdGggc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBkPSJNMTUuNzUgNmE0LjUgNC41IDAgMTEtNiA0LjI0VjE1LjI1YTQuNSA0LjUgMCAxMS02IDBWMTIiIC8+Cjwvc3ZnPgo8L3N2Zz4KPC9zdmc+';
                    }
                } catch (error) {
                    console.error('Error loading user profile:', error);
                }
            }
            
            async loadPlaylists() {
                try {
                    const playlists = await this.makeSpotifyRequest('/me/playlists?limit=20');
                    const container = document.getElementById('playlistContainer');
                    container.innerHTML = '';
                    
                    playlists.items.forEach(playlist => {
                        const playlistEl = document.createElement('div');
                        playlistEl.className = 'playlist-item cursor-pointer p-3 rounded-xl transition-all duration-300';
                        playlistEl.innerHTML = `
                            <p class="font-medium">${playlist.name}</p>
                            <p class="text-sm text-gray-600">${playlist.tracks.total} songs</p>
                        `;
                        playlistEl.addEventListener('click', () => this.playItem(playlist.uri));
                        container.appendChild(playlistEl);
                    });
                } catch (error) {
                    console.error('Error loading playlists:', error);
                }
            }
            
            async playItem(uri) {
                try {
                    await this.makeSpotifyRequest(`/me/player/play?device_id=${this.deviceId}`, {
                        method: 'PUT',
                        body: JSON.stringify({
                            context_uri: uri
                        })
                    });
                } catch (error) {
                    console.error('Error playing item:', error);
                }
            }
            
            async loadTopTracks() {
                try {
                    const topArtists = await this.makeSpotifyRequest('/me/top/artists?limit=1&time_range=short_term');
                    
                    if (topArtists.items.length > 0) {
                        const artist = topArtists.items[0];
                        document.getElementById('topArtist').textContent = artist.name;
                        if (artist.genres.length > 0) {
                            // Capitalize the first letter of each word in the genre
                            const genre = artist.genres[0].replace(/\b\w/g, l => l.toUpperCase());
                            document.getElementById('topGenre').textContent = genre;
                        } else {
                           document.getElementById('topGenre').textContent = 'Eclectic';
                        }
                    }
                } catch (error) {
                    console.error('Error loading top tracks:', error);
                }
            }
            
            async initializeWebPlayback() {
                // Ensure the Spotify SDK is loaded
                await new Promise(resolve => {
                    if (window.Spotify) {
                        resolve();
                    } else {
                        const script = document.createElement('script');
                        script.src = 'https://sdk.scdn.co/spotify-player.js';
                        script.async = true;
                        document.head.appendChild(script);
                        window.onSpotifyWebPlaybackSDKReady = resolve;
                    }
                });
                
                this.player = new Spotify.Player({
                    name: 'Lo-Fi Café Player',
                    getOAuthToken: cb => { cb(this.accessToken); },
                    volume: 0.5
                });
                
                this.player.addListener('ready', ({ device_id }) => {
                    console.log('Ready with Device ID', device_id);
                    this.deviceId = device_id;
                });
                
                this.player.addListener('not_ready', ({ device_id }) => {
                    console.log('Device ID has gone offline', device_id);
                });
                
                this.player.addListener('player_state_changed', (state) => {
                    if (state) {
                        this.updatePlayerState(state);
                    }
                });
                
                this.player.connect();
            }
            
            updatePlayerState(state) {
                if (!state) {
                    // No state information, perhaps the player is not active
                    this.isPlaying = false;
                    document.getElementById('trackName').textContent = 'No track playing';
                    document.getElementById('artistName').textContent = 'Select a track to start';
                    document.getElementById('albumArt').src = '';
                    const playBtn = document.getElementById('playBtn');
                    const vinyl = document.querySelector('.vinyl');
                    playBtn.innerHTML = '<i class="fas fa-play"></i>';
                    vinyl.classList.remove('playing');
                    return;
                }
                
                const track = state.track_window.current_track;
                this.currentTrack = track;
                this.isPlaying = !state.paused;
                
                // Update UI
                document.getElementById('trackName').textContent = track.name;
                document.getElementById('artistName').textContent = track.artists.map(a => a.name).join(', ');
                document.getElementById('albumArt').src = track.album.images[0]?.url || '';
                document.getElementById('totalTime').textContent = this.formatTime(track.duration_ms);
                 document.getElementById('currentTime').textContent = this.formatTime(state.position);
                const progress = (state.position / track.duration_ms) * 100;
                document.getElementById('progressBar').style.width = `${progress}%`;
                
                // Update play button
                const playBtn = document.getElementById('playBtn');
                const vinyl = document.querySelector('.vinyl');
                if (this.isPlaying) {
                    playBtn.innerHTML = '<i class="fas fa-pause"></i>';
                    vinyl.classList.add('playing');
                } else {
                    playBtn.innerHTML = '<i class="fas fa-play"></i>';
                    vinyl.classList.remove('playing');
                }
            }
            
            formatTime(ms) {
                const minutes = Math.floor(ms / 60000);
                const seconds = Math.floor((ms % 60000) / 1000);
                return `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
            
            async search(query) {
                try {
                    const results = await this.makeSpotifyRequest(`/search?q=${encodeURIComponent(query)}&type=track&limit=10`);
                    const container = document.getElementById('searchResults');
                    container.innerHTML = '';
                    
                    results.tracks.items.forEach(track => {
                        const trackEl = document.createElement('div');
                        trackEl.className = 'flex items-center p-3 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors';
                        trackEl.innerHTML = `
                            <img src="${track.album.images[2]?.url || ''}" alt="${track.name}" class="w-12 h-12 rounded-lg mr-3">
                            <div class="flex-grow">
                                <p class="font-medium">${track.name}</p>
                                <p class="text-sm text-gray-600">${track.artists.map(a => a.name).join(', ')}</p>
                            </div>
                            <button class="text-dusty-pink hover:text-warm-brown play-search-result" data-uri="${track.uri}">
                                <i class="fas fa-play"></i>
                            </button>
                        `;
                        container.appendChild(trackEl);
                    });
                     // Add event listeners to the new search result buttons
                    document.querySelectorAll('.play-search-result').forEach(button => {
                        button.addEventListener('click', (e) => {
                            // Use currentTarget to ensure we get the button element
                            const uri = e.currentTarget.getAttribute('data-uri');
                            this.playItem(uri);
                        });
                    });
                } catch (error) {
                    console.error('Error searching:', error);
                }
            }
            
            async togglePlay() {
                if (!this.player) return;
                await this.player.togglePlay();
            }
            
            async nextTrack() {
                if (!this.player) return;
                await this.player.nextTrack();
            }
            
            async previousTrack() {
                if (!this.player) return;
                await this.player.previousTrack();
            }
            
            async setVolume(volume) {
                 if (!this.player) return;
                await this.player.setVolume(volume / 100);
            }
            
            async getCurrentPlayback() {
                // This method is less reliable than the websocket connection from the SDK.
                // We will rely on the 'player_state_changed' listener instead for real-time updates.
                // However, we can use this for the progress bar updater.
                if (this.isPlaying && this.player) {
                    const state = await this.player.getCurrentState();
                    if(state) {
                        document.getElementById('currentTime').textContent = this.formatTime(state.position);
                        const progress = (state.position / state.duration) * 100;
                        document.getElementById('progressBar').style.width = `${progress}%`;
                    }
                }
            }
            
            setupEventListeners() {
                document.getElementById('playBtn').addEventListener('click', () => this.togglePlay());
                document.getElementById('prevBtn').addEventListener('click', () => this.previousTrack());
                document.getElementById('nextBtn').addEventListener('click', () => this.nextTrack());
                document.getElementById('volumeSlider').addEventListener('input', (e) => this.setVolume(e.target.value));
                document.getElementById('searchBtn').addEventListener('click', () => {
                    const query = document.getElementById('searchInput').value;
                    if (query) this.search(query);
                });
                document.getElementById('searchInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        const query = e.target.value;
                        if (query) this.search(query);
                    }
                });
                document.getElementById('logoutBtn').addEventListener('click', () => this.logout());
                document.getElementById('popoutBtn').addEventListener('click', () => this.openMiniplayer());
            }
            
            startProgressUpdater() {
                setInterval(() => {
                    this.getCurrentPlayback();
                }, 1000);
            }

            openMiniplayer() {
                // Miniplayer functionality can be added back here if desired.
                // This feature requires more complex state management between windows.
                alert("Miniplayer feature is under construction!");
            }
        }
        
        // Initialize everything when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            createRain();
            
            // Initialize Spotify player logic
            const spotifyPlayer = new SpotifyPlayer();
            
            // Setup login button event listener
            document.getElementById('loginBtn').addEventListener('click', () => {
                // **FIXED**: Removed unnecessary check and timeout.
                // This now directly attempts to log in.
                
                if (CLIENT_ID === 'YOUR_SPOTIFY_CLIENT_ID' || !CLIENT_ID) {
                    alert('Please set your Spotify Client ID in the script first!');
                    return;
                }
                
                document.getElementById('loginContent').classList.add('hidden');
                document.getElementById('loadingContent').classList.remove('hidden');
                
                spotifyPlayer.login();
            });
        });

        // Create rain effect
        function createRain() {
            const rainContainer = document.getElementById('rain');
            if (!rainContainer) return;
            const dropsCount = 100;
            
            for (let i = 0; i < dropsCount; i++) {
                const drop = document.createElement('div');
                drop.classList.add('drop');
                const left = Math.random() * 100;
                const duration = 1 + Math.random() * 2;
                const delay = Math.random() * 5;
                drop.style.left = `${left}%`;
                drop.style.animationDuration = `${duration}s`;
                drop.style.animationDelay = `${delay}s`;
                rainContainer.appendChild(drop);
            }
        }
    </script>
</body>
</html>